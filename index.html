<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DeliverEase â€” Home Delivery Management System</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸšš</text></svg>" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Lora:wght@600;700&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --green-900: #14532D;
    --green-800: #166534;
    --green-700: #15803D;
    --green-600: #16A34A;
    --green-100: #DCFCE7;
    --green-50 : #F0FDF4;
    --amber    : #F59E0B;
    --amber-bg : #FFFBEB;
    --red      : #DC2626;
    --red-bg   : #FEF2F2;
    --blue     : #1D4ED8;
    --blue-bg  : #EFF6FF;
    --orange   : #EA580C;
    --orange-bg: #FFF7ED;
    --purple   : #7C3AED;
    --purple-bg: #F5F3FF;
    --teal     : #0D9488;
    --teal-bg  : #F0FDFA;
    --slate-800: #1E293B;
    --slate-600: #475569;
    --slate-400: #94A3B8;
    --slate-200: #E2E8F0;
    --slate-100: #F1F5F9;
    --slate-50 : #F8FAFC;
    --white    : #ffffff;
    --shadow   : 0 1px 8px rgba(0,0,0,.07);
    --shadow-lg: 0 8px 30px rgba(0,0,0,.12);
    --radius   : 14px;
  }
  body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--green-50); color: var(--slate-800); min-height: 100vh; font-size: 15px; }
  button { font-family: inherit; cursor: pointer; }
  input, select, textarea { font-family: inherit; }

  /* â”€â”€ Header â”€â”€ */
  .header {
    background: linear-gradient(135deg, var(--green-900) 0%, var(--green-800) 60%, var(--green-700) 100%);
    padding: 0 24px;
    box-shadow: 0 4px 20px rgba(21,128,61,.35);
    position: sticky; top: 0; z-index: 100;
  }
  .header-inner { max-width: 1400px; margin: 0 auto; }
  .header-top { display: flex; align-items: center; justify-content: space-between; padding: 16px 0 0; gap: 12px; flex-wrap: wrap; }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon { font-size: 30px; }
  .logo-title { font-family: 'Lora', serif; font-size: 22px; color: #fff; font-weight: 700; }
  .logo-sub { font-size: 11px; color: #86EFAC; font-weight: 600; letter-spacing: .04em; }
  .header-right { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .header-stats { display: flex; gap: 20px; }
  .hstat { text-align: right; }
  .hstat-label { font-size: 10px; color: #86EFAC; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; }
  .hstat-value { font-size: 20px; font-weight: 800; color: #FDE68A; }
  .hstat-value.white { color: #fff; font-size: 18px; }
  .btn-add { padding: 10px 20px; border-radius: 10px; border: 2px solid rgba(255,255,255,.3); background: rgba(255,255,255,.15); font-size: 14px; font-weight: 700; color: #fff; backdrop-filter: blur(8px); transition: background .2s; }
  .btn-add:hover { background: rgba(255,255,255,.28); }
  .btn-sync { padding: 10px 16px; border-radius: 10px; border: 2px solid rgba(255,255,255,.2); background: rgba(255,255,255,.1); font-size: 13px; font-weight: 600; color: #86EFAC; }
  .btn-sync:hover { background: rgba(255,255,255,.2); }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs { display: flex; gap: 4px; margin-top: 14px; }
  .tab { padding: 10px 18px; border: none; border-radius: 8px 8px 0 0; font-size: 13px; font-weight: 600; background: transparent; color: rgba(255,255,255,.65); transition: all .2s; position: relative; }
  .tab.active { background: #fff; color: var(--green-800); }
  .tab:hover:not(.active) { color: #fff; background: rgba(255,255,255,.12); }
  .tab-badge { position: absolute; top: 6px; right: 6px; background: var(--amber); color: #fff; font-size: 9px; font-weight: 800; padding: 1px 5px; border-radius: 10px; }

  /* â”€â”€ Main â”€â”€ */
  .main { max-width: 1400px; margin: 0 auto; padding: 24px; }

  /* â”€â”€ Card â”€â”€ */
  .card { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
  .card-header { padding: 16px 20px; border-bottom: 1px solid var(--slate-100); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
  .card-title { font-size: 15px; font-weight: 700; color: var(--slate-800); }
  .card-title span { color: var(--slate-400); font-weight: 400; font-size: 13px; margin-left: 6px; }

  /* â”€â”€ Stat Cards â”€â”€ */
  .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 14px; margin-bottom: 18px; }
  .stat-card { border-radius: var(--radius); padding: 16px 18px; }
  .stat-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; margin-bottom: 8px; }
  .stat-value { font-size: 22px; font-weight: 800; color: var(--slate-800); }

  /* â”€â”€ Filter Bar â”€â”€ */
  .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .filter-input { border: 1.5px solid var(--slate-200); border-radius: 8px; padding: 7px 12px; font-size: 13px; outline: none; background: var(--slate-50); color: var(--slate-800); min-width: 150px; }
  .filter-input:focus { border-color: var(--green-600); }
  .btn-clear { padding: 7px 12px; border-radius: 8px; border: 1.5px solid #FCA5A5; background: var(--red-bg); font-size: 12px; font-weight: 600; color: var(--red); }

  /* â”€â”€ Table â”€â”€ */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 1200px; }
  thead tr { background: var(--slate-50); }
  th { padding: 10px 11px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--slate-400); border-bottom: 1px solid var(--slate-100); white-space: nowrap; }
  td { padding: 10px 11px; font-size: 13px; color: var(--slate-800); border-bottom: 1px solid var(--slate-100); vertical-align: middle; }
  tbody tr:hover { background: var(--green-50); }
  .td-bill { font-weight: 700; color: var(--blue); }
  .td-name { font-weight: 600; }
  .td-amount { font-weight: 800; }
  .td-actions { white-space: nowrap; }
  .badge-mode { background: var(--blue-bg); color: var(--blue); padding: 2px 7px; border-radius: 12px; font-size: 10px; font-weight: 700; white-space: nowrap; }
  .badge-expected { background: var(--orange-bg); color: var(--orange); padding: 2px 7px; border-radius: 12px; font-size: 10px; font-weight: 700; white-space: nowrap; }
  .badge-delivery  { background: #EFF6FF; color: #1D4ED8; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; white-space: nowrap; }
  .badge-paylater  { background: #FEF3C7; color: #92400E; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; white-space: nowrap; }
  .badge-prepaid   { background: #ECFDF5; color: #065F46; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; white-space: nowrap; }
  .act-btn-sms     { background: #F0F9FF; color: #0284C7; }
  .order-type-toggle { display:flex; gap:0; border-radius:10px; overflow:hidden; border:2px solid var(--slate-200); }
  .ott-btn { flex:1; padding:10px 8px; border:none; font-size:13px; font-weight:700; cursor:pointer; transition: all .2s; background: var(--slate-50); color: var(--slate-600); }
  .ott-btn.active-delivery { background: #1D4ED8; color:#fff; }
  .ott-btn.active-paylater { background: #92400E; color:#fff; }
  .delivery-only { transition: opacity .2s; }
  .delivery-only.hidden { opacity:.3; pointer-events:none; }
  .badge-status { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; white-space: nowrap; }
  .badge-pending  { background: #FEF3C7; color: #92400E; }
  .badge-received { background: var(--green-100); color: #065F46; }
  .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
  .dot-pending  { background: var(--amber); }
  .dot-received { background: #10B981; }

  /* â”€â”€ Action Buttons â”€â”€ */
  .act-btn { border: none; border-radius: 6px; padding: 4px 7px; font-size: 11px; font-weight: 700; margin-right: 3px; cursor: pointer; }
  .act-btn-receive { background: var(--green-100); color: #065F46; }
  .act-btn-wa      { background: #DCFCE7; color: var(--green-600); }
  .act-btn-followup{ background: #FEF3C7; color: #92400E; }
  .act-btn-group   { background: var(--orange-bg); color: var(--orange); }
  .act-btn-edit    { background: var(--blue-bg); color: var(--blue); }
  .act-btn-del     { background: var(--red-bg); color: var(--red); }

  /* â”€â”€ Combo Filter â”€â”€ */
  .filter-combo-wrap { position: relative; display: inline-block; }
  .filter-combo { cursor: default; }
  .combo-dropdown { position: absolute; top: calc(100% + 4px); left: 0; z-index: 200;
    background: #fff; border: 1.5px solid var(--slate-200); border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,.12); min-width: 100%; max-height: 200px; overflow-y: auto;
    display: none; }
  .combo-option { padding: 8px 14px; font-size: 13px; cursor: pointer; color: var(--slate-800); }
  .combo-option:hover { background: var(--green-50); }
  .combo-all { color: var(--slate-400); font-style: italic; }
  .combo-selected { background: var(--green-50); color: var(--green-800); font-weight: 700; }

  /* â”€â”€ Empty State â”€â”€ */
  .empty { padding: 60px; text-align: center; color: var(--slate-400); }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-text { font-size: 15px; font-weight: 600; }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,.6); backdrop-filter: blur(4px); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 16px; }
  .modal { background: #fff; border-radius: 16px; width: 100%; max-width: 720px; max-height: 92vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
  .modal-head { padding: 20px 28px 16px; border-bottom: 1px solid var(--slate-100); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: #fff; z-index: 1; }
  .modal-title { font-family: 'Lora', serif; font-size: 18px; font-weight: 700; color: var(--slate-800); }
  .modal-close { background: none; border: none; font-size: 22px; color: var(--slate-400); line-height: 1; cursor: pointer; }
  .modal-body { padding: 24px 28px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.full { grid-column: 1 / -1; }
  .form-label { font-size: 11px; font-weight: 700; color: var(--slate-400); text-transform: uppercase; letter-spacing: .06em; }
  .form-control { border: 1.5px solid var(--slate-200); border-radius: 8px; padding: 9px 12px; font-size: 14px; outline: none; color: var(--slate-800); background: var(--slate-50); transition: border-color .2s; }
  .form-control:focus { border-color: var(--green-600); background: #fff; }
  .form-section-title { grid-column: 1 / -1; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: .1em; color: var(--green-700); padding: 8px 0 4px; border-bottom: 2px solid var(--green-100); margin-top: 4px; }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }
  .btn-cancel { padding: 10px 22px; border-radius: 8px; border: 1.5px solid var(--slate-200); background: #fff; font-size: 14px; font-weight: 600; color: var(--slate-600); cursor: pointer; }
  .btn-save { padding: 10px 28px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--green-600), var(--green-800)); font-size: 14px; font-weight: 700; color: #fff; box-shadow: 0 4px 12px rgba(22,163,74,.3); cursor: pointer; }

  /* â”€â”€ Post-Save Modal â”€â”€ */
  .post-save-info { background: var(--green-50); border: 1.5px solid var(--green-100); border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; font-size: 14px; color: var(--green-800); line-height: 1.6; }
  .post-save-btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-size: 15px; font-weight: 700; color: #fff; cursor: pointer; margin-bottom: 10px; transition: opacity .2s; }
  .post-save-btn:hover { opacity: .9; }
  .post-save-btn.wa-customer { background: linear-gradient(135deg, #25D366, #128C7E); }
  .post-save-btn.wa-group { background: linear-gradient(135deg, #FF6B35, #F59E0B); }
  .post-save-tip { font-size: 11px; color: var(--slate-400); text-align: center; margin-top: 10px; line-height: 1.5; }

  /* â”€â”€ Analytics â”€â”€ */
  .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .bar-row { margin-bottom: 14px; }
  .bar-meta { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
  .bar-key { font-weight: 600; color: var(--slate-800); }
  .bar-val { color: var(--slate-400); }
  .bar-track { height: 12px; border-radius: 6px; background: var(--slate-100); overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 6px; background: linear-gradient(90deg, var(--green-600), #4ADE80); }
  .bar-legend { display: flex; gap: 14px; margin-top: 4px; font-size: 11px; color: var(--slate-400); }

  /* â”€â”€ Summary â”€â”€ */
  .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .summary-row { display: flex; justify-content: space-between; padding: 11px 0; border-bottom: 1px solid var(--slate-50); font-size: 14px; }
  .summary-key { color: var(--slate-600); font-weight: 500; }

  /* â”€â”€ Setup Banner â”€â”€ */
  .setup-banner { background: #FEF3C7; border: 1.5px solid #FCD34D; border-radius: var(--radius); padding: 16px 20px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 12px; }
  .setup-banner-icon { font-size: 22px; flex-shrink: 0; }
  .setup-banner-title { font-size: 14px; font-weight: 700; color: #92400E; margin-bottom: 4px; }
  .setup-banner-text { font-size: 13px; color: #92400E; line-height: 1.5; }
  .setup-banner a { color: var(--blue); font-weight: 600; }

  /* â”€â”€ Bill photo preview â”€â”€ */
  .bill-preview-img { max-width: 100%; max-height: 140px; border-radius: 8px; object-fit: cover; border: 1.5px solid var(--slate-200); display: block; margin-top: 8px; }
  .photo-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--orange-bg); color: var(--orange); padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; margin-top: 8px; }

  /* â”€â”€ Spinner & Toast â”€â”€ */
  .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin .7s linear infinite; vertical-align: middle; margin-right: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; color: #fff; box-shadow: var(--shadow-lg); z-index: 9999; animation: slideUp .25s ease; max-width: 320px; }
  .toast-success { background: var(--green-700); }
  .toast-error   { background: var(--red); }
  .toast-info    { background: var(--blue); }
  @keyframes slideUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

  /* â”€â”€ Received Modal â”€â”€ */
  .confirm-text { font-size: 14px; color: var(--slate-600); margin-bottom: 14px; }

  /* â”€â”€ Group Toggle â”€â”€ */
  .group-toggle { display: flex; gap: 6px; }
  .gtbtn { padding: 7px 15px; border-radius: 8px; border: 1.5px solid var(--slate-200); background: #fff; font-size: 12px; font-weight: 700; color: var(--slate-600); cursor: pointer; }
  .gtbtn.active { background: var(--green-800); color: #fff; border-color: var(--green-800); }

  /* â”€â”€ Timing Metric Card â”€â”€ */
  .timing-card { border-radius: var(--radius); padding: 16px 18px; display: flex; flex-direction: column; gap: 4px; }
  .timing-icon { font-size: 20px; margin-bottom: 4px; }
  .timing-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; }
  .timing-value { font-size: 22px; font-weight: 800; color: var(--slate-800); }
  .timing-sub { font-size: 11px; color: var(--slate-400); }

  @media (max-width: 640px) {
    .form-grid, .analytics-grid, .summary-grid { grid-template-columns: 1fr; }
    .header-right { gap: 8px; }
    .hstat-value { font-size: 16px; }
    .header-stats { gap: 12px; }
  }
</style>
</head>
<body>

<!-- â•â• HEADER â•â• -->
<header class="header">
  <div class="header-inner">
    <div class="header-top">
      <div class="logo">
        <span class="logo-icon">ğŸšš</span>
        <div>
          <div class="logo-title">DeliverEase</div>
          <div class="logo-sub">Home Delivery Management System</div>
        </div>
      </div>
      <div class="header-right">
        <div class="header-stats">
          <div class="hstat">
            <div class="hstat-label">Active Orders</div>
            <div class="hstat-value white" id="headerActive">0</div>
          </div>
          <div class="hstat">
            <div class="hstat-label">Pending Amount</div>
            <div class="hstat-value" id="headerPending">â‚¹0</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:2px"><button class="btn-sync" onclick="loadData()" id="syncBtn">ğŸ”„ Sync</button><span id="lastSyncLabel" style="font-size:9px;color:#86EFAC;opacity:.7;font-weight:500"></span></div>
        <button class="btn-add" onclick="openAddModal()">+ New Order</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="master"    onclick="switchTab('master')">ğŸ“‹ All Orders</button>
      <button class="tab"        data-tab="pending"   onclick="switchTab('pending')">ğŸ’³ Pending Payments <span class="tab-badge" id="pendingBadge" style="display:none"></span></button>
      <button class="tab"        data-tab="deliveries" onclick="switchTab('deliveries')">ğŸšš Pending Deliveries <span class="tab-badge" id="deliveriesBadge" style="display:none"></span></button>
      <button class="tab"        data-tab="analytics" onclick="switchTab('analytics')">ğŸ“ˆ Analytics</button>
      <button class="tab"        data-tab="settings"  onclick="switchTab('settings')">âš™ï¸ Settings</button>
    </div>
  </div>
</header>

<!-- â•â• MAIN â•â• -->
<main class="main">

  <!-- Setup Banner -->
  <div class="setup-banner" id="setupBanner">
    <span class="setup-banner-icon">âš™ï¸</span>
    <div>
      <div class="setup-banner-title">Setup Required â€” Connect your Google Sheet &amp; configure constants</div>
      <div class="setup-banner-text">
        1. Replace <strong>YOUR_APPS_SCRIPT_WEB_APP_URL</strong> with your deployed Google Apps Script URL.<br>
        2. Set <strong>SHOP_NAME</strong> to your store name.<br>
        3. Set <strong>DELIVERY_GROUP_PHONE</strong> to your delivery WhatsApp group admin/number (for direct alerts).<br>
        Once connected, click <strong>ğŸ”„ Sync</strong> to load your data.
      </div>
    </div>
  </div>

  <!-- â”€â”€ ALL ORDERS TAB â”€â”€ -->
  <div id="tab-master">
    <div class="card">
      <div class="card-header">
        <div class="card-title">All Orders <span id="masterCount"></span></div>
        <div class="filter-bar" id="masterFilters"></div>
      </div>
      <div class="table-wrap"><table id="masterTable"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- â”€â”€ PENDING TAB â”€â”€ -->
  <div id="tab-pending" style="display:none">
    <div class="stat-grid" id="pendingStats"></div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">Pending Payments <span id="pendingCount"></span></div>
        <div class="filter-bar" id="pendingFilters"></div>
      </div>
      <div class="table-wrap"><table id="pendingTable"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- â”€â”€ PENDING DELIVERIES TAB â”€â”€ -->
  <div id="tab-deliveries" style="display:none">
    <div class="stat-grid" id="deliveriesStats" style="margin-bottom:18px"></div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">Pending Deliveries <span id="deliveriesCount"></span></div>
        <div class="filter-bar" id="deliveriesFilters"></div>
      </div>
      <div class="table-wrap"><table id="deliveriesTable"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- â”€â”€ ANALYTICS TAB â”€â”€ -->
  <div id="tab-analytics" style="display:none">

    <!-- Group-by selector -->
    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
      <span style="font-size:12px;font-weight:700;color:var(--slate-400);text-transform:uppercase;letter-spacing:.06em">View:</span>
      <div class="group-toggle">
        <button class="gtbtn active" data-group="day"   onclick="setGroup('day')">Daily</button>
        <button class="gtbtn"        data-group="week"  onclick="setGroup('week')">Weekly</button>
        <button class="gtbtn"        data-group="month" onclick="setGroup('month')">Monthly</button>
      </div>
    </div>

    <!-- Overview stat cards (all orders â€” pending + received) -->
    <div class="stat-grid" id="analyticsOverview" style="margin-bottom:18px"></div>

    <!-- Timing Metrics -->
    <div class="stat-grid" id="timingMetrics" style="margin-bottom:18px"></div>

    <!-- Row 1: Value + Count charts -->
    <div class="analytics-grid">
      <div class="card" style="padding:24px">
        <div class="card-title" style="margin-bottom:18px" id="allChartTitle">Order Value â€” Daily</div>
        <div id="allChart"></div>
      </div>
      <div class="card" style="padding:24px">
        <div class="card-title" style="margin-bottom:18px" id="countChartTitle">Orders Count â€” Daily</div>
        <div id="countChart"></div>
      </div>
    </div>

    <!-- Row 2: Processing & Delivery Time Trends -->
    <div class="analytics-grid" style="margin-top:18px">
      <div class="card" style="padding:24px">
        <div class="card-title" style="margin-bottom:4px">âš¡ Order Processing Time Trend</div>
        <div style="font-size:11px;color:var(--slate-400);margin-bottom:14px">Order Received â†’ Billed (avg minutes)</div>
        <div id="processingChart"></div>
      </div>
      <div class="card" style="padding:24px">
        <div class="card-title" style="margin-bottom:4px">ğŸšš Order Delivery Time Trend</div>
        <div style="font-size:11px;color:var(--slate-400);margin-bottom:14px">Billed â†’ Delivered (avg minutes, received orders)</div>
        <div id="deliveryChart"></div>
      </div>
    </div>

    <!-- Staff Performance â€” two sub-tabs -->
    <div class="card" style="padding:24px;margin-top:18px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div class="card-title">ğŸ‘¥ Staff Performance</div>
        <div class="group-toggle">
          <button class="gtbtn active" id="staff-tab-shop"     onclick="switchStaffTab('shop')">ğŸª In-Shop</button>
          <button class="gtbtn"        id="staff-tab-delivery" onclick="switchStaffTab('delivery')">ğŸšš Delivery</button>
        </div>
      </div>
      <div id="staffStatsInShop"></div>
      <div id="staffStatsDelivery" style="display:none"></div>
    </div>
  </div>

  <!-- â”€â”€ SETTINGS TAB â”€â”€ -->
  <div id="tab-settings" style="display:none">
    <div class="card" style="max-width:640px;margin:0 auto;padding:28px 32px">
      <div class="card-title" style="font-size:17px;margin-bottom:6px">âš™ï¸ Configuration Settings</div>
      <p style="font-size:13px;color:var(--slate-600);margin-bottom:24px">Edit these values in the <code style="background:var(--slate-100);padding:2px 6px;border-radius:5px;font-size:12px">&lt;script&gt;</code> section at the top of the HTML file. Changes require saving the file.</p>

      <div style="display:flex;flex-direction:column;gap:20px">

        <!-- WhatsApp Group Link -->
        <div style="background:var(--green-50);border:1.5px solid var(--green-100);border-radius:12px;padding:18px 20px">
          <div style="font-weight:700;font-size:14px;margin-bottom:4px">ğŸ“± WhatsApp Delivery Team Group Link</div>
          <div style="font-size:12px;color:var(--slate-600);margin-bottom:12px">Used by the <strong>"Alert Delivery Team"</strong> button after saving an order.</div>
          <div style="background:#fff;border:1.5px solid var(--slate-200);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--slate-600);margin-bottom:12px">
            <strong>Current value:</strong> <span id="settingWaLink" style="color:var(--green-700);font-weight:700"></span>
          </div>
          <div style="font-size:12px;font-weight:700;color:var(--slate-700);margin-bottom:6px">How to get your group invite link:</div>
          <ol style="font-size:12px;color:var(--slate-600);padding-left:18px;line-height:1.9">
            <li>Open <strong>WhatsApp</strong> on your phone</li>
            <li>Go to your <strong>Delivery Team group</strong></li>
            <li>Tap the group name at the top â†’ scroll down</li>
            <li>Tap <strong>"Invite via link"</strong></li>
            <li>Tap <strong>"Copy link"</strong></li>
            <li>Open this HTML file in a text editor (Notepad / VS Code)</li>
            <li>Find the line: <code style="background:var(--slate-100);padding:1px 5px;border-radius:4px">const DELIVERY_GROUP_LINK = "YOUR_WHATSAPP_GROUP_INVITE_LINK";</code></li>
            <li>Replace <strong>YOUR_WHATSAPP_GROUP_INVITE_LINK</strong> with the copied link</li>
            <li>Save the file and reload in your browser</li>
          </ol>
          <div style="margin-top:12px;background:#FFFBEB;border:1.5px solid #FDE68A;border-radius:8px;padding:10px 14px;font-size:12px;color:#92400E">
            ğŸ’¡ The link looks like: <strong>https://chat.whatsapp.com/AbCdEfGhIjKlMnOpQrStUv</strong>
          </div>
        </div>

        <!-- Other config -->
        <div style="background:var(--slate-50);border:1.5px solid var(--slate-200);border-radius:12px;padding:18px 20px">
          <div style="font-weight:700;font-size:14px;margin-bottom:10px">ğŸ“ Other Settings (edit in file)</div>
          <table style="width:100%;font-size:12px;border-collapse:collapse">
            <tr><td style="padding:6px 0;color:var(--slate-500);width:200px">Shop Name</td><td style="font-weight:700" id="settingShopName"></td></tr>
            <tr><td style="padding:6px 0;color:var(--slate-500)">Country Code</td><td style="font-weight:700" id="settingCountry"></td></tr>
            <tr><td style="padding:6px 0;color:var(--slate-500)">Delete Password</td><td style="font-weight:700">â—â—â—â—â—â—â—â— (hidden)</td></tr>
          </table>
        </div>

      </div>
    </div>
  </div>

</main>

<!-- â•â• MODALS â•â• -->

<!-- Add / Edit Entry Modal -->
<div class="modal-overlay" id="entryModal" style="display:none" onclick="closeModalOnBg(event,'entryModal')">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Add New Order</div>
      <button class="modal-close" onclick="closeModal('entryModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" id="entryForm"></div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal('entryModal')">Cancel</button>
        <button class="btn-save"   onclick="saveEntry()" id="saveBtn">Save Order</button>
      </div>
    </div>
  </div>
</div>

<!-- Mark Received Modal -->
<div class="modal-overlay" id="receivedModal" style="display:none" onclick="closeModalOnBg(event,'receivedModal')">
  <div class="modal" style="max-width:400px">
    <div class="modal-head">
      <div class="modal-title">Mark Payment Received</div>
      <button class="modal-close" onclick="closeModal('receivedModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="receivedBillInfo" style="background:var(--green-50);border:1.5px solid var(--green-100);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:13px;color:var(--green-800);line-height:1.7"></div>
      <div class="form-grid" style="margin-bottom:0">
        <div class="form-group">
          <label class="form-label">Received By <span style="color:var(--red)">*</span></label>
          <input class="form-control" id="receivedByInput" placeholder="Enter staff nameâ€¦" required />
        </div>
        <div class="form-group">
          <label class="form-label">Payment Received Date <span style="color:var(--red)">*</span></label>
          <input class="form-control" id="receivedDateInput" type="date" required />
        </div>
        <div class="form-group full">
          <label class="form-label">Actual Payment Mode <span style="color:var(--red)">*</span></label>
          <select class="form-control" id="receivedModeInput">
            <option value="">-- Select mode --</option>
            ${DELIVERY_MODES.map(m=>`<option value="${m}">${m}</option>`).join("")}
          </select>
        </div>
      </div>
      <div id="receivedError" style="display:none;color:var(--red);font-size:12px;font-weight:700;margin:8px 0">âš ï¸ All fields are required to mark as received.</div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal('receivedModal')">Cancel</button>
        <button class="btn-save"   onclick="confirmReceived()" id="receiveConfirmBtn">âœ“ Confirm Received</button>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ” Delete Password Modal -->
<div class="modal-overlay" id="deleteModal" style="display:none" onclick="closeModalOnBg(event,'deleteModal')">
  <div class="modal" style="max-width:400px">
    <div class="modal-head">
      <div class="modal-title">ğŸ—‘ Confirm Delete</div>
      <button class="modal-close" onclick="closeModal('deleteModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">You are about to permanently delete:</p>
      <div id="deleteEntryInfo" style="background:var(--red-bg);border:1.5px solid #FCA5A5;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;font-weight:700;color:var(--red)"></div>
      <label class="form-label">Enter delete password to confirm</label>
      <input class="form-control" id="deletePasswordInput" type="password" placeholder="Enter passwordâ€¦" style="width:100%"
        onkeydown="if(event.key==='Enter')confirmDelete()" />
      <div id="deleteError" style="display:none;color:var(--red);font-size:12px;font-weight:700;margin-top:8px">âŒ Wrong password. Entry not deleted.</div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal('deleteModal')">Cancel</button>
        <button class="btn-save" onclick="confirmDelete()" id="deleteConfirmBtn" style="background:var(--red)">ğŸ—‘ Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Post-Save Actions Modal -->
<div class="modal-overlay" id="postSaveModal" style="display:none" onclick="closeModalOnBg(event,'postSaveModal')">
  <div class="modal" style="max-width:460px">
    <div class="modal-head">
      <div class="modal-title">âœ… Order Entry Saved!</div>
      <button class="modal-close" onclick="closePostSaveModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="post-save-info" id="postSaveInfo"></div>
      <div id="postSavePhotoNote" style="display:none">
        <div class="photo-badge">ğŸ“¸ Bill photo attached â€” will be shared with customer</div>
      </div>
      <p style="font-size:12px;font-weight:700;color:var(--slate-600);margin:18px 0 12px;text-transform:uppercase;letter-spacing:.06em">Quick Actions</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button class="post-save-btn wa-customer" onclick="shareWithCustomer()" style="margin-bottom:0">
          ğŸ“± Bill via WhatsApp
        </button>
        <button class="post-save-btn" style="background:linear-gradient(135deg,#0369A1,#0EA5E9);margin-bottom:0" onclick="sendSMSFromModal()">
          ğŸ’¬ Bill via SMS
        </button>
      </div>
      <div id="postSaveGroupAlert" style="margin-top:10px"></div>
      <button class="btn-cancel" style="width:100%;padding:11px;text-align:center;margin-top:10px" onclick="closePostSaveModal()">
        Done â€” Skip for now
      </button>
      <p class="post-save-tip">
        ğŸ’¡ WhatsApp button opens the customer's chat directly (no contact selection needed).<br>
        For Delivery Alert: message is auto-copied to clipboard, then your group opens â€” just paste &amp; send.
      </p>
    </div>
  </div>
</div>


<!-- ğŸšš Mark Delivered Modal -->
<div class="modal-overlay" id="deliveryModal" style="display:none" onclick="closeModalOnBg(event,'deliveryModal')">
  <div class="modal" style="max-width:420px">
    <div class="modal-head">
      <div class="modal-title">ğŸšš Mark as Delivered</div>
      <button class="modal-close" onclick="closeModal('deliveryModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="deliveryBillInfo" style="background:var(--green-50);border:1.5px solid var(--green-100);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:13px;color:var(--green-800);line-height:1.7"></div>
      <div class="form-grid" style="margin-bottom:0">
        <div class="form-group">
          <label class="form-label">Delivery Person <span style="color:var(--red)">*</span></label>
          <input class="form-control" id="deliveryPersonInput" placeholder="Enter delivery person nameâ€¦" />
        </div>
        <div class="form-group">
          <label class="form-label">Delivery Time <span style="color:var(--red)">*</span></label>
          <input class="form-control" id="deliveryTimeInput" type="time" />
        </div>
      </div>
      <div id="deliveryError" style="display:none;color:var(--red);font-size:12px;font-weight:700;margin:8px 0">âš ï¸ Both delivery person and delivery time are required.</div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal('deliveryModal')">Cancel</button>
        <button class="btn-save" onclick="confirmDelivered()" id="deliveryConfirmBtn">âœ“ Mark Delivered</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â• SCRIPT â•â• -->
<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  ğŸ”§  CONFIGURATION â€” UPDATE THESE VALUES                â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APPS_SCRIPT_URL      = "https://script.google.com/macros/s/AKfycbwkupivAAta3mVzzAP2pg_rnXBGCAQT1DLw19tWqfMt_O35mPCE8Uw784WFZW43EtcHNg/exec";
const SHOP_NAME            = "Amaze On";
// WhatsApp Group invite link for delivery team
// Set to your WhatsApp group invite link from: Open Group > ... > Invite via link
const DELIVERY_GROUP_LINK  = "https://chat.whatsapp.com/BDxXjAOvYcE4sm8BeXK9Ce";
// e.g. "https://chat.whatsapp.com/XXXXXXXXXXXXXXXXXXXXXX"
const COUNTRY_CODE         = "91"; // India
const DELETE_PASSWORD      = "amaze2024"; // Password required to delete any entry
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const DELIVERY_MODES = ["Paytm", "Cash", "Phonepe", "Razorpay", "Card", "Sodexo"];

const FORM_FIELDS = [
  // â”€â”€ Order Type (rendered specially by renderForm) â”€â”€
  { key:"OrderType",         label:"Order Type",           type:"ordertype", half:false },
  // â”€â”€ Order Details â”€â”€
  { key:"_s1",               label:"ğŸ“¦ Order Details",    type:"section" },
  { key:"Date",              label:"Order Date",           type:"date",     half:true },
  { key:"BillNumber",        label:"Bill Number",          type:"text",     half:true },
  { key:"CustomerName",      label:"Customer Name",        type:"text",     half:true },
  { key:"Phone",             label:"Phone Number",         type:"tel",      half:true },
  { key:"Amount",            label:"Amount (â‚¹)",           type:"number",   half:true },
  { key:"ExpectedPaymentMode", label:"Expected Payment Mode (by Customer)", type:"select", half:true, options: DELIVERY_MODES },
  { key:"Prepaid",          label:"Already Paid (Prepaid Order)",      type:"prepaid", half:false, addOnly:true },
  // â”€â”€ Timing â”€â”€
  { key:"_s2",               label:"â± Timing",             type:"section" },
  { key:"TakenBy",           label:"Order Taken By",       type:"text",     half:true },
  { key:"OrderTime",         label:"Order Received Time",  type:"time",     half:true },
  { key:"BilledTime",        label:"Order Billed Time",    type:"time",     half:true },
  // Delivery-only fields (hidden for Pay Later)
  { key:"DeliveryTime",      label:"Delivery Time",        type:"time",     half:true,  deliveryOnly:true, editOnly:true },
  { key:"DeliveryPerson",    label:"Delivery Person",      type:"text",     half:true,  deliveryOnly:true, editOnly:true },
  { key:"PaymentMode",       label:"Actual Payment Mode",  type:"select",   half:true, options: DELIVERY_MODES, editOnly:true },
  // â”€â”€ Edit-only â”€â”€
  { key:"Status",            label:"Status",               type:"select",   half:true, options:["pending","received"], editOnly:true },
  { key:"ReceivedBy",        label:"Received By",          type:"text",     half:true, editOnly:true },
  // â”€â”€ Bill Photo (add-only) â”€â”€
  { key:"_s3",               label:"ğŸ“¸ Bill Photo",        type:"section",  addOnly:true },
  { key:"BillPhoto",         label:"Attach Bill Image (shared via WhatsApp, not stored)", type:"file", half:false, addOnly:true },
  // â”€â”€ Notes â”€â”€
  { key:"Notes",             label:"Notes",                type:"textarea", half:false },
];

let allEntries      = [];
let editingId       = null;
let markId          = null;
let markDeliveryId  = null;
let lastSavedEntry  = null;
let billPhotoFile   = null;
let pendingDeleteId = null;
let activeTab       = "master";
let groupBy         = "day";
let filters         = { master:{}, pending:{}, deliveries:{}, analytics:{} };
let lastSyncTime    = null;
let autoSyncTimer   = null;
const AUTO_SYNC_MS  = 2 * 60 * 1000; // 2 minutes

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Retry with exponential backoff to handle concurrent device access safely
async function api(method, body, retries = 4) {
  const isDemo = APPS_SCRIPT_URL === "YOUR_APPS_SCRIPT_WEB_APP_URL";
  if (isDemo) { showToast("Demo mode â€” connect your Google Sheet first", "info"); return null; }
  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      // âš ï¸ CRITICAL: Do NOT set Content-Type header on POST to Apps Script.
      // Setting it triggers a CORS preflight (OPTIONS) which Apps Script does not support,
      // causing every save to fail. Without the header, it's a simple request â†’ no preflight â†’ works.
      // Apps Script reads e.postData.contents regardless of Content-Type.
      const opts = method === "GET"
        ? { method:"GET", redirect:"follow" }
        : { method:"POST", redirect:"follow", body: JSON.stringify(body) };
      const res = await fetch(APPS_SCRIPT_URL, opts);
      // Apps Script may return 200 on redirect chain â€” don't error on 3xx
      if (!res.ok && res.status >= 400) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (data.error) {
        // Retry on lock contention errors from Apps Script
        if (attempt < retries && data.error.includes("Lock")) {
          await sleep(300 * Math.pow(2, attempt) + Math.random() * 200);
          continue;
        }
        showToast("Error: " + data.error, "error"); return null;
      }
      return data;
    } catch(e) {
      if (attempt < retries) {
        await sleep(400 * Math.pow(2, attempt) + Math.random() * 300);
        continue;
      }
      showToast("Network error: " + e.message + ". Please retry.", "error"); return null;
    }
  }
  return null;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function loadData(silent = false) {
  if (!silent) {
    const syncBtn = document.getElementById("syncBtn");
    syncBtn.innerHTML = '<span class="spinner"></span>Syncingâ€¦';
    syncBtn.disabled = true;
  }
  const data = await api("GET");
  if (data && data.entries) {
    allEntries = data.entries;
    lastSyncTime = new Date();
    updateSyncLabel();
    if (!silent) showToast("Synced " + allEntries.length + " orders âœ“");
  } else if (!data && !silent) {
    showToast("âš ï¸ Could not reach Google Sheet. Check Apps Script deployment.", "error");
  }
  if (!silent) {
    const syncBtn = document.getElementById("syncBtn");
    syncBtn.innerHTML = "ğŸ”„ Sync";
    syncBtn.disabled = false;
  }
  renderAll();
}

function updateSyncLabel() {
  const el = document.getElementById("lastSyncLabel");
  if (!el || !lastSyncTime) return;
  const s = Math.round((Date.now() - lastSyncTime) / 1000);
  el.textContent = s < 60 ? "synced just now" : `synced ${Math.round(s/60)}m ago`;
}

function startAutoSync() {
  if (autoSyncTimer) clearInterval(autoSyncTimer);
  autoSyncTimer = setInterval(async () => {
    const anyModalOpen = [...document.querySelectorAll(".modal-overlay")].some(m => m.style.display === "flex");
    if (anyModalOpen) return; // don't interrupt user
    const isDemo = APPS_SCRIPT_URL === "YOUR_APPS_SCRIPT_WEB_APP_URL";
    if (isDemo) return;
    await loadData(true); // silent
  }, AUTO_SYNC_MS);
  // Tick the label every 30s so it stays fresh
  setInterval(updateSyncLabel, 30000);
}

// â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveEntry() {
  const data = collectForm();
  // Mandatory field validation (except Notes)
  const mandatoryFields = [
    { key:"Date",              label:"Order Date" },
    { key:"BillNumber",        label:"Bill Number" },
    { key:"CustomerName",      label:"Customer Name" },
    { key:"Phone",             label:"Phone Number" },
    { key:"Amount",            label:"Amount" },
    { key:"ExpectedPaymentMode", label:"Expected Payment Mode" },
    { key:"TakenBy",           label:"Order Taken By" },
    { key:"OrderTime",         label:"Order Received Time" },
    { key:"BilledTime",        label:"Order Billed Time" },
  ];
  // Delivery person & time are NOT mandatory on new orders (filled later via Pending Deliveries tab)
  const isDeliveryOrder = (data.OrderType || "Home Delivery") !== "Pay Later";
  for (const f of mandatoryFields) {
    if (!data[f.key] || !String(data[f.key]).trim()) {
      showToast(`âš ï¸ ${f.label} is required`, "error"); return;
    }
  }
  // Bill photo is mandatory for new orders
  if (!editingId && !billPhotoFile) {
    showToast("âš ï¸ Bill image is required â€” please attach a photo of the bill", "error");
    return;
  }
  // Bill photo is mandatory for new orders
  if (!editingId && !billPhotoFile) {
    showToast("âš ï¸ Bill image is required â€” please attach a photo of the bill", "error");
    return;
  }
  // Duplicate bill number check
  if (!editingId) {
    const dup = allEntries.find(e => e.BillNumber && e.BillNumber.trim().toLowerCase() === data.BillNumber.trim().toLowerCase());
    if (dup) {
      showToast(`âš ï¸ Bill Number "${data.BillNumber}" already exists for ${dup.CustomerName}. Please use a unique bill number.`, "error");
      return;
    }
  } else {
    const dup = allEntries.find(e => e.ID !== editingId && e.BillNumber && e.BillNumber.trim().toLowerCase() === data.BillNumber.trim().toLowerCase());
    if (dup) {
      showToast(`âš ï¸ Bill Number "${data.BillNumber}" already used for ${dup.CustomerName}. Please use a unique bill number.`, "error");
      return;
    }
  }
  const btn = document.getElementById("saveBtn");
  btn.innerHTML = '<span class="spinner"></span>Savingâ€¦';
  btn.disabled = true;

  if (editingId) {
    data.ID = editingId;
    const res = await api("POST", { action:"update", data });
    if (res?.success) {
      const idx = allEntries.findIndex(e => e.ID === editingId);
      if (idx !== -1) allEntries[idx] = { ...allEntries[idx], ...data };
      showToast("Order updated âœ“");
      closeModal("entryModal");
      renderAll();
    }
    btn.innerHTML = "Save Changes";
  } else {
    const isPrepaid = data.Prepaid === "true" || data.Prepaid === true;
    data.Status = isPrepaid ? "received" : "pending";
    if (isPrepaid) {
      data.PaymentMode  = data.ExpectedPaymentMode || "";
      data.ReceivedBy   = data.TakenBy || "Prepaid";
      data.PaymentDate  = data.Date;
    } else {
      data.PaymentMode = data.PaymentMode || data.ExpectedPaymentMode || "";
    }
    delete data.Prepaid; // don't save UI field to sheet
    let newId, newEntry;

    const res = await api("POST", { action:"add", data });
    if (res?.success) {
      newId = res.id;
      newEntry = { ...data, ID: newId };
      allEntries.push(newEntry);
      showToast("Order saved to sheet âœ“");
    } else {
      // Fallback: save locally so work isn't lost, flag as unsynced
      newId = "local_" + Date.now();
      newEntry = { ...data, ID: newId, _unsynced: true };
      allEntries.push(newEntry);
      showToast("âš ï¸ Saved locally â€” sheet sync failed. Check connection & retry Sync.", "error");
    }

    lastSavedEntry = newEntry;
    closeModal("entryModal");
    renderAll();
    openPostSaveModal();
    btn.innerHTML = "Save Order";
  }
  btn.disabled = false;
}

function deleteEntry(id) {
  pendingDeleteId = id;
  document.getElementById("deletePasswordInput").value = "";
  document.getElementById("deleteError").style.display = "none";
  const e = allEntries.find(x => x.ID === id) || {};
  document.getElementById("deleteEntryInfo").textContent = `Bill: ${e.BillNumber||"â€”"} â€” ${e.CustomerName||"â€”"} â€” ${fmtCur(e.Amount)}`;
  document.getElementById("deleteModal").style.display = "flex";
  setTimeout(() => document.getElementById("deletePasswordInput").focus(), 100);
}

async function confirmDelete() {
  const pwd = document.getElementById("deletePasswordInput").value;
  if (pwd !== DELETE_PASSWORD) {
    document.getElementById("deleteError").style.display = "block";
    return;
  }
  const btn = document.getElementById("deleteConfirmBtn");
  btn.innerHTML = '<span class="spinner"></span>';
  btn.disabled = true;
  const res = await api("POST", { action:"delete", id: pendingDeleteId });
  if (res?.success) {
    allEntries = allEntries.filter(e => e.ID !== pendingDeleteId);
    showToast("Entry deleted", "error");
    closeModal("deleteModal");
    renderAll();
  }
  btn.innerHTML = "ğŸ—‘ Delete";
  btn.disabled = false;
}

async function confirmReceived() {
  const name = document.getElementById("receivedByInput").value.trim();
  const pdate= document.getElementById("receivedDateInput").value;
  const mode = (document.getElementById("receivedModeInput")?.value || "").trim();
  const errEl= document.getElementById("receivedError");

  // Validate all mandatory
  if (!name || !pdate || !mode) {
    errEl.style.display = "block";
    return;
  }
  errEl.style.display = "none";

  const btn  = document.getElementById("receiveConfirmBtn");
  btn.innerHTML = '<span class="spinner"></span>';
  btn.disabled = true;
  const data = { ID: markId, Status: "received", ReceivedBy: name, PaymentDate: pdate, PaymentMode: mode };
  const res  = await api("POST", { action:"update", data });
  if (res?.success) {
    const idx = allEntries.findIndex(e => e.ID === markId);
    if (idx !== -1) {
      allEntries[idx].Status      = "received";
      allEntries[idx].ReceivedBy  = name;
      allEntries[idx].PaymentDate = pdate;
      allEntries[idx].PaymentMode = mode;
    }
    showToast(`âœ“ Received by ${name} via ${mode} on ${fmtDate(pdate)}`);
    closeModal("receivedModal");
    renderTablesOnly();
  }
  btn.innerHTML = "âœ“ Confirm Received";
  btn.disabled = false;
}

// â”€â”€ POST-SAVE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPostSaveModal() {
  const e = lastSavedEntry;
  if (!e) return;

  const isDelivery  = (e.OrderType || "Home Delivery") !== "Pay Later";
  // Outstanding bills check â€” by phone number
  const normPhone   = (e.Phone||"").replace(/\D/g,"").slice(-10);
  const custPending = allEntries.filter(x => {
    const xp = (x.Phone||"").replace(/\D/g,"").slice(-10);
    return normPhone && xp === normPhone && x.Status === "pending";
  });
  const totalDue = custPending.reduce((s,x) => s + Number(x.Amount||0), 0);

  document.getElementById("postSaveInfo").innerHTML =
    `${isDelivery?"ğŸšš":"ğŸª"} <strong>${e.OrderType||"Home Delivery"}</strong> &nbsp;|&nbsp; <strong>ğŸ“¦ ${e.BillNumber}</strong><br>` +
    `ğŸ‘¤ <strong>${e.CustomerName}</strong> &nbsp;|&nbsp; ğŸ“ ${e.Phone || "â€”"}<br>` +
    `ğŸ’° <strong>${fmtCur(e.Amount)}</strong> &nbsp;|&nbsp; ğŸ’³ Expected: <strong>${e.ExpectedPaymentMode || "â€”"}</strong><br>` +
    `<span style="font-size:11px;color:#059669;font-weight:600">ğŸ“± WA/SMS bill buttons below will send only THIS order's details</span>` +
    (custPending.length > 1 ? `<br><span style="color:#DC2626;font-weight:700;font-size:12px">âš ï¸ This customer has ${custPending.length} pending bills totalling ${fmtCur(totalDue)} â€” use WA F/U to send all</span>` : "");

  const photoNote = document.getElementById("postSavePhotoNote");
  photoNote.style.display = billPhotoFile ? "block" : "none";

  // Show/hide delivery group alert button based on order type
  const alertWrap = document.getElementById("postSaveGroupAlert");
  if (alertWrap) {
    alertWrap.innerHTML = isDelivery
      ? `<button class="post-save-btn wa-group" style="margin-top:10px" onclick="sendGroupAlertFromModal()">ğŸšš Alert Delivery Team via WhatsApp</button>`
      : `<div style="background:#FFFBEB;border:1.5px solid #FCD34D;border-radius:8px;padding:10px 14px;margin-top:10px;font-size:12px;color:#92400E">
           ğŸª <strong>Walk-in / Pay Later order</strong> â€” no delivery team alert needed.
         </div>`;
  }

  document.getElementById("postSaveModal").style.display = "flex";
}

function closePostSaveModal() {
  document.getElementById("postSaveModal").style.display = "none";
  billPhotoFile  = null;
  lastSavedEntry = null;
}

// â”€â”€ WHATSAPP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCustomerMessage(entry) {
  // Single order bill notification â€” shows only THIS order's details
  const isDelivery = (entry.OrderType || "Home Delivery") !== "Pay Later";
  const expMode    = entry.ExpectedPaymentMode || entry.PaymentMode || "â€”";
  // Razorpay = paid online upfront; status "received" = prepaid checkbox was ticked
  const isAlreadyPaid = ["Razorpay"].includes(entry.ExpectedPaymentMode) || entry.Status === "received";

  if (isDelivery) {
    // Home Delivery: order is ready and will be delivered shortly
    const lines = [
      `ğŸšš *Order Update from ${SHOP_NAME}*`,
      ``,
      `Dear *${entry.CustomerName}*,`,
      ``,
      `Great news! Your order has been *picked, billed and packed* by our team and will be *delivered to you shortly*. ğŸ‰`,
      ``,
      `ğŸ“„ Bill No: *${entry.BillNumber}*`,
      `ğŸ“… Date: ${fmtDate(entry.Date)}`,
      `ğŸ’° Amount: *${fmtCur(entry.Amount)}*`,
      `ğŸ’³ Payment Mode: *${expMode}*`,
    ];
    if (isAlreadyPaid) {
      lines.push(``, `âœ… *Payment received â€” this bill is shared for your reference only.*`);
    } else {
      lines.push(``, `ğŸ“¸ Kindly keep the payment ready. Once received, please share the *screenshot of the transaction* so we can update your account.`);
    }
    lines.push(``, `Thank you for your order! ğŸ™`, `â€” *${SHOP_NAME}*`);
    return lines.join("\n");
  } else {
    // Pay Later (Walk-in)
    const lines = [
      `ğŸª *Bill from ${SHOP_NAME}*`,
      ``,
      `Dear *${entry.CustomerName}*,`,
      ``,
      `Please find your bill details below:`,
      ``,
      `ğŸ“„ Bill No: *${entry.BillNumber}*`,
      `ğŸ“… Date: ${fmtDate(entry.Date)}`,
      `ğŸ’° Amount Due: *${fmtCur(entry.Amount)}*`,
      `ğŸ’³ Payment Mode: *${expMode}*`,
    ];
    if (isAlreadyPaid) {
      lines.push(``, `âœ… *Payment received â€” this bill is shared for your reference only.*`);
    } else {
      lines.push(``, `ğŸ“¸ Kindly make the payment and share the *screenshot of the transaction* so we can update your account.`);
    }
    lines.push(``, `Thank you for your business! ğŸ™`, `â€” *${SHOP_NAME}*`);
    return lines.join("\n");
  }
}

function buildFollowUpMessage(customerName, phone) {
  const normPhone = (phone||"").replace(/\D/g,"").slice(-10); // last 10 digits
  const custPending = allEntries
    .filter(x => {
      const xPhone = (x.Phone||"").replace(/\D/g,"").slice(-10);
      return normPhone && xPhone === normPhone && x.Status === "pending";
    })
    .slice().sort((a,b) => (a.Date||"").localeCompare(b.Date||""));
  if (!custPending.length) { showToast("No pending bills for this customer", "info"); return null; }
  const totalDue    = custPending.reduce((s,x) => s + Number(x.Amount||0), 0);
  const oldest      = custPending[0];
  const daysPending = Math.floor((Date.now() - new Date(oldest.Date)) / 86400000);

  const lines = [
    `âš ï¸ *Payment Reminder â€” ${SHOP_NAME}*`,
    ``,
    `Dear *${customerName}*,`,
    ``,
    `This is a gentle reminder that you have *${custPending.length} outstanding bill(s)* totalling *${fmtCur(totalDue)}*.`,
    ``,
    `ğŸ“‹ *Pending Bill Details:*`,
  ];

  custPending.forEach((b, i) => {
    lines.push(`${i+1}. Bill No: *${b.BillNumber}*  |  ${fmtDate(b.Date)}  |  *${fmtCur(b.Amount)}*`);
  });

  lines.push(
    ``,
    `ğŸ’° *Total Outstanding: ${fmtCur(totalDue)}*`,
    daysPending > 0 ? `â° Oldest bill is *${daysPending} day(s)* old.` : ``,
    ``,
    `Kindly make the payment at your earliest convenience and share the *payment screenshot* so we can update your account.`,
    ``,
    `Thank you! ğŸ™`,
    `â€” *${SHOP_NAME}*`,
  );
  return lines.filter(l => l !== undefined).join("\n");
}


// â”€â”€ PENDING DELIVERIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDeliveryModal(id) {
  markDeliveryId = id;
  const e = allEntries.find(x => x.ID === id) || {};
  document.getElementById("deliveryPersonInput").value = e.DeliveryPerson || "";
  document.getElementById("deliveryTimeInput").value   = new Date().toTimeString().slice(0,5);
  document.getElementById("deliveryError").style.display = "none";
  const info = document.getElementById("deliveryBillInfo");
  if (info) info.innerHTML =
    `<strong>ğŸ“¦ ${e.BillNumber||"â€”"}</strong> â€” ${e.CustomerName||"â€”"}<br>` +
    `ğŸ’° Amount: <strong>${fmtCur(e.Amount)}</strong> &nbsp;|&nbsp; ` +
    `ğŸ“… Date: ${fmtDate(e.Date)}` +
    (e.TakenBy ? `<br>ğŸª Taken By: ${e.TakenBy}` : "");
  document.getElementById("deliveryModal").style.display = "flex";
  setTimeout(() => document.getElementById("deliveryPersonInput").focus(), 100);
}

async function confirmDelivered() {
  const person = document.getElementById("deliveryPersonInput").value.trim();
  const time   = document.getElementById("deliveryTimeInput").value;
  const errEl  = document.getElementById("deliveryError");
  if (!person || !time) { errEl.style.display = "block"; return; }
  errEl.style.display = "none";
  const btn = document.getElementById("deliveryConfirmBtn");
  btn.innerHTML = '<span class="spinner"></span>';
  btn.disabled = true;
  const data = { ID: markDeliveryId, DeliveryPerson: person, DeliveryTime: time };
  const res = await api("POST", { action:"update", data });
  if (res?.success) {
    const idx = allEntries.findIndex(e => e.ID === markDeliveryId);
    if (idx !== -1) { allEntries[idx].DeliveryPerson = person; allEntries[idx].DeliveryTime = time; }
    showToast(`âœ“ Delivered by ${person} at ${fmtTime(time)}`);
    closeModal("deliveryModal");
    renderTablesOnly();
  }
  btn.innerHTML = "âœ“ Mark Delivered";
  btn.disabled = false;
}

function sendFollowUp(id) {
  const e = allEntries.find(x => x.ID === id);
  if (!e) { showToast("Order not found", "error"); return; }
  if (!e.Phone) { showToast("No phone number for this customer", "error"); return; }
  const msg = buildFollowUpMessage(e.CustomerName, e.Phone);
  if (!msg) return;
  openWhatsApp(e.Phone, msg, null, "Payment Follow-up");
}

function sendFollowUpSMS(id) {
  const e = allEntries.find(x => x.ID === id);
  if (!e) { showToast("Order not found", "error"); return; }
  if (!e.Phone) { showToast("No phone number for this customer", "error"); return; }
  const msg = buildFollowUpMessage(e.CustomerName, e.Phone);
  if (!msg) return;
  openSMS(e.Phone, msg);
}

function buildGroupAlertMessage(entry) {
  // Match outstanding bills by phone number (not name) for accuracy
  const normPhone   = (entry.Phone||"").replace(/\D/g,"").slice(-10);
  const custPending = normPhone
    ? allEntries.filter(x => (x.Phone||"").replace(/\D/g,"").slice(-10) === normPhone && x.Status === "pending")
    : allEntries.filter(x => x.CustomerName === entry.CustomerName && x.Status === "pending");
  const totalDue    = custPending.reduce((s,x) => s + Number(x.Amount||0), 0);

  // Razorpay = online prepaid; Status "received" = prepaid checkbox ticked â€” no cash collection needed
  const isPaid = ["Razorpay"].includes(entry.ExpectedPaymentMode) || entry.Status === "received";

  const lines = [
    `ğŸšš *Home Delivery Order Received!*`, ``,
    `ğŸ“„ *Bill No:* ${entry.BillNumber}`,
    `ğŸ‘¤ *Customer:* ${entry.CustomerName}`,
    `ğŸ“ *Mobile:* ${entry.Phone || "â€”"}`,
    `ğŸ’° *Amount:* ${fmtCur(entry.Amount)}`,
    `ğŸ’³ *Payment Mode (Communicated by Customer):* ${entry.ExpectedPaymentMode || "â€”"}`,
    isPaid
      ? `âœ… *Payment Status: PAID â€” No collection needed on delivery*`
      : `â³ *Payment Status: Pending â€” Collect ${fmtCur(entry.Amount)} on delivery*`,
    `â° *Order Time:* ${entry.OrderTime || "â€”"}`,
    `ğŸ·ï¸ *Taken By:* ${entry.TakenBy || "â€”"}`,
  ];

  if (custPending.length > 1) {
    lines.push(``, `ğŸ“‹ *All Pending Bills for ${entry.CustomerName}:*`);
    custPending.forEach((b,i) => lines.push(`  ${i+1}. Bill: ${b.BillNumber} | ${fmtDate(b.Date)} | ${fmtCur(b.Amount)}`));
    lines.push(`ğŸ’° *Total Outstanding: ${fmtCur(totalDue)}*`);
  }

  lines.push(``, `Please proceed with delivery. Thank you! ğŸ™`);
  return lines.join("\n");
}

function shareWithCustomer() {
  const e = lastSavedEntry;
  if (!e) { showToast("No saved entry found", "error"); return; }
  const ph = String(e.Phone||"").replace(/\D/g,"");
  if (ph.length < 10) {
    showToast("âš ï¸ No valid phone number â€” cannot open WhatsApp", "error"); return;
  }
  openWhatsApp(String(e.Phone), buildCustomerMessage(e), billPhotoFile, `Bill - ${e.BillNumber}`);
}

// Core WhatsApp opener â€” always opens direct chat via wa.me, with optional photo share on mobile
function openWhatsApp(phone, msg, photoFile, shareTitle) {
  const digits = (phone || "").replace(/\D/g,"");
  // Normalise to full international format without +
  // Handles: 10-digit, 0-prefix, already-has-91-prefix
  let normalised;
  if      (digits.length === 12 && digits.startsWith("91")) normalised = digits;
  else if (digits.length === 11 && digits.startsWith("0"))  normalised = "91" + digits.slice(1);
  else if (digits.length === 10)                             normalised = "91" + digits;
  else                                                       normalised = digits; // pass through and hope
  if (normalised.length < 10) {
    showToast("âš ï¸ Phone number missing or invalid â€” cannot open WhatsApp", "error");
    return;
  }
  // Use api.whatsapp.com/send with type=phone_number â€” most reliable for direct chat on all devices
  // This bypasses the contact picker and opens the conversation directly
  const waUrl = `https://wa.me/${normalised}?text=${encodeURIComponent(msg)}`;

  // If photo attached AND on mobile with Web Share API â†’ share natively (opens WhatsApp share sheet)
  if (photoFile && typeof navigator.share === "function" && typeof navigator.canShare === "function") {
    const shareData = { files: [photoFile], text: msg, title: shareTitle || "Bill" };
    if (navigator.canShare(shareData)) {
      navigator.share(shareData)
        .then(() => showToast("Shared via WhatsApp âœ“"))
        .catch(err => {
          if (err.name !== "AbortError") {
            const _a = document.createElement("a"); _a.href = waUrl; _a.target = "_blank"; _a.rel = "noopener noreferrer";
            document.body.appendChild(_a); _a.click(); document.body.removeChild(_a);
            showToast("ğŸ“¸ Attach bill image manually in WhatsApp", "info");
          }
        });
      return;
    }
  }

  // Default: open WhatsApp via anchor click â€” opens WA without navigating away from the app
  // On desktop it opens WhatsApp Web; on mobile it deep-links into the app directly
  const waAnchor = document.createElement("a");
  waAnchor.href = waUrl;
  waAnchor.target = "_blank";
  waAnchor.rel = "noopener noreferrer";
  document.body.appendChild(waAnchor);
  waAnchor.click();
  document.body.removeChild(waAnchor);
  if (photoFile) showToast("ğŸ“¸ Photo ready â€” attach it manually in WhatsApp after it opens", "info");
}

function openSMS(phone, msg) {
  const digits = (phone || "").replace(/\D/g,"");
  if (!digits || digits.length < 10) {
    showToast("âš ï¸ Phone number missing or invalid â€” cannot open SMS", "error");
    return;
  }
  // Normalise same way as openWhatsApp â€” strip country code duplicate
  let ph;
  if      (digits.length === 12 && digits.startsWith("91")) ph = digits.slice(2);
  else if (digits.length === 11 && digits.startsWith("0"))  ph = digits.slice(1);
  else ph = digits;
  const plainMsg = msg.replace(/\*/g,"").replace(/~/g,"").replace(/_/g,"");
  const smsUrl = `sms:+${COUNTRY_CODE}${ph}?body=${encodeURIComponent(plainMsg)}`;
  const a = document.createElement("a"); a.href = smsUrl; a.target = "_blank";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function sendGroupAlertFromModal() {
  if (lastSavedEntry) sendGroupAlert(lastSavedEntry.ID);
}

function sendFollowUpFromModal() {
  if (lastSavedEntry) sendFollowUp(lastSavedEntry.ID);
}

function sendSMSFromModal() {
  const e = lastSavedEntry;
  if (!e) return;
  openSMS(e.Phone, buildCustomerMessage(e));
}

function sendFollowUpSMSFromModal() {
  const e = lastSavedEntry;
  if (!e) return;
  const msg = buildFollowUpMessage(e.CustomerName, e.Phone);
  if (msg) openSMS(e.Phone, msg);
}

function sendGroupAlert(id) {
  const e = allEntries.find(x => x.ID === id);
  if (!e) return;
  const msg = buildGroupAlertMessage(e);
  const link = (typeof DELIVERY_GROUP_LINK !== "undefined" ? DELIVERY_GROUP_LINK : "");
  const isValidLink = link && !link.includes("YOUR_WHATSAPP") && link.startsWith("https://");

  if (!isValidLink) {
    showToast("âš™ï¸ Paste your WhatsApp group invite link into DELIVERY_GROUP_LINK in the config", "error");
    if (navigator.clipboard) navigator.clipboard.writeText(msg).catch(()=>{});
    return;
  }
  // Copy message then open group â€” user pastes message in group
  const openGroup = () => {
    const a = document.createElement("a");
    a.href = link; a.target = "_blank"; a.rel = "noopener";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };
  if (navigator.clipboard) {
    navigator.clipboard.writeText(msg)
      .then(() => { showToast("âœ… Message copied â€” paste it in the group chat!", "info"); setTimeout(openGroup, 300); })
      .catch(() => { showToast("Opening groupâ€¦", "info"); openGroup(); });
  } else {
    openGroup();
  }
}

function sendWhatsApp(id) {
  const e = allEntries.find(x => x.ID === id);
  if (!e) return;
  openWhatsApp(e.Phone, buildCustomerMessage(e), null, `Bill - ${e.BillNumber}`);
}

function sendSMS(id) {
  const e = allEntries.find(x => x.ID === id);
  if (!e) return;
  openSMS(e.Phone, buildCustomerMessage(e));
}



// â”€â”€ RENDER ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  document.getElementById("setupBanner").style.display = "none";
  renderTablesOnly();
}

// â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(tableId, countId, data, pendingOnly) {
  const table  = document.getElementById(tableId);
  const cols   = ["Type","Date","BillNumber","CustomerName","Phone","Amount","ExpectedPaymentMode","PaymentMode","TakenBy","OrderTime","BilledTime","DeliveryTime","DeliveryPerson","ProcessTime","DelivTime","Status","ReceivedBy","PaymentDate","Actions"];
  const labels = ["Type","Date","Bill No","Customer","Phone","Amount","Exp. Mode","Actual Mode","Taken By","Order Time","Billed Time","Del. Time","Del. Person","âš¡ Process","ğŸšš Deliver","Status","Rcvd By","Rcvd Date","Actions"];
  table.querySelector("thead").innerHTML = `<tr>${labels.map(h=>`<th>${h}</th>`).join("")}</tr>`;
  if (!data.length) {
    table.querySelector("tbody").innerHTML = `<tr><td colspan="${cols.length}" class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">No orders found</div></td></tr>`;
    document.getElementById(countId).textContent = "(0)";
    return;
  }
  document.getElementById(countId).textContent = `(${data.length})`;
  table.querySelector("tbody").innerHTML = data.map(e => {
    const isDelivery = (e.OrderType || "Home Delivery") !== "Pay Later";
    const typeBadge = isDelivery
      ? `<span class="badge-delivery">ğŸšš Delivery</span>`
      : `<span class="badge-paylater">ğŸª Pay Later</span>`;
    return `
    <tr>
      <td>${typeBadge}</td>
      <td>${fmtDate(e.Date)}</td>
      <td class="td-bill">${e.BillNumber||"â€”"}</td>
      <td class="td-name">${e.CustomerName||"â€”"}</td>
      <td>${e.Phone||"â€”"}</td>
      <td class="td-amount">${fmtCur(e.Amount)}</td>
      <td><span class="badge-expected">${e.ExpectedPaymentMode||"â€”"}</span></td>
      <td><span class="badge-mode">${e.PaymentMode||"â€”"}</span></td>
      <td>${e.TakenBy||"â€”"}</td>
      <td>${fmtTime(e.OrderTime)}</td>
      <td>${fmtTime(e.BilledTime)}</td>
      <td>${isDelivery?fmtTime(e.DeliveryTime):"â€”"}</td>
      <td>${isDelivery?(e.DeliveryPerson||"â€”"):"â€”"}</td>
      <td>${(()=>{ const t1=parseTimeToHHMM(e.OrderTime),t2=parseTimeToHHMM(e.BilledTime); const d=t1&&t2?timeDiffMinutes(t1,t2):-1; return d>0?`<span style="font-size:11px;color:#7C3AED;font-weight:700">${d}m</span>`:"â€”"; })()}</td>
      <td>${(()=>{ if(!isDelivery) return "â€”"; const t1=parseTimeToHHMM(e.BilledTime),t2=parseTimeToHHMM(e.DeliveryTime); const d=t1&&t2?timeDiffMinutes(t1,t2):-1; return d>0?`<span style="font-size:11px;color:#0D9488;font-weight:700">${d}m</span>`:"â€”"; })()}</td>
      <td><span class="badge-status ${e.Status==="pending"?"badge-pending":"badge-received"}"><span class="dot ${e.Status==="pending"?"dot-pending":"dot-received"}"></span>${e.Status==="pending"?"Pending":"Received"}</span></td>
      <td>${e.ReceivedBy ? `<span style="font-size:11px;font-weight:700;color:#065F46">${e.ReceivedBy}</span>` : "â€”"}</td>
      <td>${e.PaymentDate ? fmtDate(e.PaymentDate) : "â€”"}</td>
      <td class="td-actions">
        ${e.Status==="pending" ? `
          <button class="act-btn act-btn-receive"  onclick="openReceiveModal('${e.ID}')"  title="Mark Received">âœ“ Rcvd</button>
          <button class="act-btn act-btn-wa"       onclick="sendWhatsApp('${e.ID}')"      title="Send Bill via WhatsApp">ğŸ“± WA</button>
          <button class="act-btn act-btn-sms"      onclick="sendSMS('${e.ID}')"           title="Send Bill via SMS">ğŸ’¬ SMS</button>
          <button class="act-btn act-btn-followup" onclick="sendFollowUp('${e.ID}')"      title="Follow-up via WhatsApp">ğŸ”” WA F/U</button>
          <button class="act-btn act-btn-sms"      onclick="sendFollowUpSMS('${e.ID}')"   title="Follow-up via SMS">ğŸ“² SMS F/U</button>
          ${isDelivery?`<button class="act-btn act-btn-group" onclick="sendGroupAlert('${e.ID}')" title="Alert Delivery Group">ğŸšš Alert</button>`:""}
        ` : `<span style="font-size:11px;color:#10B981;font-weight:700">âœ… Received</span>`}
        <button class="act-btn act-btn-edit" onclick="openEditModal('${e.ID}')"  title="Edit">âœï¸</button>
        <button class="act-btn act-btn-del"  onclick="deleteEntry('${e.ID}')"    title="Delete">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join("");
}

function renderPendingStats(pending) {
  const total  = pending.reduce((s,e) => s + Number(e.Amount||0), 0);
  const oldest = pending.length ? pending.slice().sort((a,b)=>a.Date.localeCompare(b.Date))[0].Date : null;
  const today  = new Date().toISOString().split("T")[0];
  const todayCnt = pending.filter(e=>e.Date===today).length;
  document.getElementById("pendingStats").innerHTML = [
    { label:"Pending Bills",      value: pending.length,   color:"#F59E0B", bg:"#FFFBEB" },
    { label:"Total Amount Due",   value: fmtCur(total),    color:"#DC2626", bg:"#FEF2F2" },
    { label:"Due Today",          value: todayCnt,         color:"#7C3AED", bg:"#F5F3FF" },
    { label:"Oldest Pending",     value: oldest ? fmtDate(oldest) : "â€”", color:"#0D9488", bg:"#F0FDFA" },
  ].map(c=>`
    <div class="stat-card" style="background:${c.bg};border:1.5px solid ${c.color}22">
      <div class="stat-label" style="color:${c.color}">${c.label}</div>
      <div class="stat-value">${c.value}</div>
    </div>
  `).join("");
}

// Summary tab removed



function renderSummary(all, pending, totalPending) {
  const filtAll     = filterByPeriod(all);
  const filtPending = filtAll.filter(e => e.Status === "pending");
  const filtRecvd   = filtAll.filter(e => e.Status === "received");
  const filtPendAmt = filtPending.reduce((s,e)=>s+Number(e.Amount||0),0);
  const totalReceived = filtRecvd.reduce((s,e)=>s+Number(e.Amount||0),0);

  document.getElementById("summaryOverview").innerHTML = [
    ["Total Orders",         filtAll.length,                  "#1D4ED8"],
    ["Pending Orders",       filtPending.length,              "#F59E0B"],
    ["Delivered & Received", filtRecvd.length,                "#10B981"],
    ["Total Pending Amount", fmtCur(filtPendAmt),             "#DC2626"],
    ["Total Received",       fmtCur(totalReceived),           "#10B981"],
    ["Total Business Value", fmtCur(filtPendAmt+totalReceived), "#7C3AED"],
  ].map(([k,v,c])=>`<div class="summary-row"><span class="summary-key">${k}</span><span style="font-weight:800;color:${c}">${v}</span></div>`).join("");

  const modeMap = {};
  filtPending.forEach(e=>{const m=e.ExpectedPaymentMode||e.PaymentMode||"Other";modeMap[m]=(modeMap[m]||0)+Number(e.Amount||0);});
  document.getElementById("summaryByMode").innerHTML = Object.entries(modeMap).sort(([,a],[,b])=>b-a).map(([mode,amt])=>`
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px">
        <span style="font-weight:600">${mode}</span><span style="color:#64748B">${fmtCur(amt)}</span>
      </div>
      <div style="height:8px;border-radius:4px;background:#F1F5F9">
        <div style="height:100%;width:${filtPendAmt?(amt/filtPendAmt*100):0}%;background:linear-gradient(90deg,#F59E0B,#FBBF24);border-radius:4px"></div>
      </div>
    </div>
  `).join("") || "<p style='color:#94A3B8;font-size:13px'>No pending entries for this period</p>";

  const custMap = {};
  filtPending.forEach(e=>{custMap[e.CustomerName]=(custMap[e.CustomerName]||0)+Number(e.Amount||0);});
  document.getElementById("summaryTopCustomers").innerHTML = Object.entries(custMap).sort(([,a],[,b])=>b-a).slice(0,5).map(([name,amt])=>`
    <div class="summary-row"><span class="summary-key">${name}</span><span style="font-weight:800;color:#DC2626">${fmtCur(amt)}</span></div>
  `).join("") || "<p style='color:#94A3B8;font-size:13px'>No pending entries for this period</p>";
}

// â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeStaffTab = "shop";

function switchStaffTab(tab) {
  activeStaffTab = tab;
  document.getElementById("staff-tab-shop").classList.toggle("active", tab==="shop");
  document.getElementById("staff-tab-delivery").classList.toggle("active", tab==="delivery");
  document.getElementById("staffStatsInShop").style.display     = tab==="shop" ? "" : "none";
  document.getElementById("staffStatsDelivery").style.display   = tab==="delivery" ? "" : "none";
}

let analyticsPeriod = "all";

function setAnalyticsPeriod(p) {
  analyticsPeriod = p;
  document.querySelectorAll("[data-ag]").forEach(b => b.classList.toggle("active", b.dataset.ag===p));
  renderAnalytics();
}

function getAnalyticsData() {
  const today     = new Date().toISOString().split("T")[0];
  const thisWeek  = getWeekKey(today);
  const thisMonth = today.slice(0,7);
  if (analyticsPeriod === "today") return allEntries.filter(e => e.Date === today);
  if (analyticsPeriod === "week")  return allEntries.filter(e => getWeekKey(e.Date) === thisWeek);
  if (analyticsPeriod === "month") return allEntries.filter(e => e.Date && e.Date.startsWith(thisMonth));
  return allEntries.slice(); // "all"
}

function renderAnalyticsOverview(data) {
  const pending  = data.filter(e => e.Status === "pending");
  const received = data.filter(e => e.Status === "received");
  const pendAmt  = pending.reduce((s,e)=>s+Number(e.Amount||0),0);
  const rcvdAmt  = received.reduce((s,e)=>s+Number(e.Amount||0),0);
  const cards = [
    { label:"Total Orders",    value:data.length,       color:"#1D4ED8", bg:"#EFF6FF", icon:"ğŸ“¦" },
    { label:"Pending",         value:pending.length,    color:"#F59E0B", bg:"#FFFBEB", icon:"â³" },
    { label:"Received",        value:received.length,   color:"#059669", bg:"#ECFDF5", icon:"âœ…" },
    { label:"Pending Amount",  value:fmtCur(pendAmt),   color:"#DC2626", bg:"#FEF2F2", icon:"ğŸ’¸" },
    { label:"Received Amount", value:fmtCur(rcvdAmt),   color:"#10B981", bg:"#F0FDFA", icon:"ğŸ’°" },
    { label:"Total Business",  value:fmtCur(pendAmt+rcvdAmt), color:"#7C3AED", bg:"#F5F3FF", icon:"ğŸ†" },
  ];
  const el = document.getElementById("analyticsOverview");
  if (el) el.innerHTML = cards.map(card=>`
    <div class="stat-card" style="background:${card.bg};border:1.5px solid ${card.color}22">
      <div style="font-size:20px;margin-bottom:4px">${card.icon}</div>
      <div class="stat-label" style="color:${card.color}">${card.label}</div>
      <div class="stat-value">${card.value}</div>
    </div>`).join("");
}

function renderAnalytics() {
  const fdata = getAnalyticsData();
  const label = groupBy==="day"?"Daily":groupBy==="week"?"Weekly":"Monthly";

  renderAnalyticsOverview(fdata);
  renderTimingMetrics(fdata);
  renderValueChart("allChart", fdata);
  renderCountChart("countChart", fdata);
  renderTimingChart("processingChart", fdata, "processing");
  renderTimingChart("deliveryChart",   fdata, "delivery");

  document.getElementById("allChartTitle").textContent   = `Order Value â€” ${label}`;
  document.getElementById("countChartTitle").textContent = `Orders Count â€” ${label}`;

  renderStaffPerformance(fdata);
}

function renderStaffPerformance(data) {
  // â”€â”€ IN-SHOP PERFORMANCE (TakenBy) â”€â”€
  const shopMap = {};
  data.forEach(e => {
    if (!e.TakenBy) return;
    shopMap[e.TakenBy] = shopMap[e.TakenBy] || {total:0, pending:0, received:0, totalAmt:0, procTimes:[]};
    shopMap[e.TakenBy].total++;
    shopMap[e.TakenBy].totalAmt += Number(e.Amount||0);
    if (e.Status==="pending")   shopMap[e.TakenBy].pending++;
    else                        shopMap[e.TakenBy].received++;
    const t1=parseTimeToHHMM(e.OrderTime), t2=parseTimeToHHMM(e.BilledTime);
    if (t1&&t2) { const d=timeDiffMinutes(t1,t2); if(d>0&&d<240) shopMap[e.TakenBy].procTimes.push(d); }
  });

  document.getElementById("staffStatsInShop").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px">
    ${Object.entries(shopMap).sort(([,a],[,b])=>b.total-a.total).map(([name,s]) => {
      const avgProc = s.procTimes.length ? Math.round(s.procTimes.reduce((a,b)=>a+b,0)/s.procTimes.length) : null;
      return `<div style="background:#F8FAFC;border-radius:12px;padding:16px;border:1.5px solid #E2E8F0">
        <div style="font-weight:800;font-size:14px;margin-bottom:10px">ğŸª ${name}</div>
        <div style="font-size:12px;color:#475569;margin-bottom:4px">Total Orders: <strong>${s.total}</strong></div>
        <div style="font-size:12px;color:#10B981;margin-bottom:4px">Received: <strong>${s.received}</strong></div>
        <div style="font-size:12px;color:#F59E0B;margin-bottom:4px">Pending: <strong>${s.pending}</strong></div>
        <div style="font-size:12px;color:#1D4ED8;margin-bottom:4px">Value: <strong>${fmtCur(s.totalAmt)}</strong></div>
        <div style="font-size:12px;color:#7C3AED">âš¡ Avg Process: <strong>${avgProc!==null?avgProc+"m":"â€”"}</strong></div>
      </div>`;
    }).join("") || "<p style='color:#94A3B8;font-size:13px'>No data</p>"}
    </div>`;

  // â”€â”€ DELIVERY PERFORMANCE (DeliveryPerson) â”€â”€
  const delivMap = {};
  data.forEach(e => {
    if (!e.DeliveryPerson) return;
    delivMap[e.DeliveryPerson] = delivMap[e.DeliveryPerson] || {total:0, totalAmt:0, delivTimes:[]};
    delivMap[e.DeliveryPerson].total++;
    delivMap[e.DeliveryPerson].totalAmt += Number(e.Amount||0);

    const t1=parseTimeToHHMM(e.BilledTime), t2=parseTimeToHHMM(e.DeliveryTime);
    if (t1&&t2) { const d=timeDiffMinutes(t1,t2); if(d>0&&d<600) delivMap[e.DeliveryPerson].delivTimes.push(d); }
  });

  document.getElementById("staffStatsDelivery").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px">
    ${Object.entries(delivMap).sort(([,a],[,b])=>b.total-a.total).map(([name,s]) => {
      const avgDel = s.delivTimes.length ? Math.round(s.delivTimes.reduce((a,b)=>a+b,0)/s.delivTimes.length) : null;
      return `<div style="background:#F8FAFC;border-radius:12px;padding:16px;border:1.5px solid #E2E8F0">
        <div style="font-weight:800;font-size:14px;margin-bottom:10px">ğŸšš ${name}</div>
        <div style="font-size:12px;color:#475569;margin-bottom:4px">Deliveries: <strong>${s.total}</strong></div>
        <div style="font-size:12px;color:#1D4ED8;margin-bottom:4px">Value: <strong>${fmtCur(s.totalAmt)}</strong></div>
        <div style="font-size:12px;color:#0D9488;margin-bottom:4px">ğŸšš Avg Delivery: <strong>${avgDel!==null?avgDel+"m":"â€”"}</strong></div>
      </div>`;
    }).join("") || "<p style='color:#94A3B8;font-size:13px'>No delivery data</p>"}
    </div>`;
}

function renderTimingMetrics(data) {
  // Processing time: OrderTime â†’ BilledTime
  const procTimes = data
    .filter(e => e.OrderTime && e.BilledTime)
    .map(e => timeDiffMinutes(e.OrderTime, e.BilledTime))
    .filter(t => t > 0 && t < 240);

  // Delivery time: BilledTime â†’ DeliveryTime
  const delTimes = data
    .filter(e => e.BilledTime && e.DeliveryTime)
    .map(e => timeDiffMinutes(e.BilledTime, e.DeliveryTime))
    .filter(t => t > 0 && t < 480);

  const avgProc = procTimes.length ? Math.round(procTimes.reduce((a,b)=>a+b,0)/procTimes.length) : null;
  const avgDel  = delTimes.length  ? Math.round(delTimes.reduce((a,b)=>a+b,0)/delTimes.length)   : null;

  const metrics = [
    { label:"Avg Processing Time", value: avgProc!==null?`${avgProc} min`:"â€”", sub:"Order â†’ Billed",    icon:"âš¡", color:"#7C3AED", bg:"#F5F3FF" },
    { label:"Avg Delivery Time",   value: avgDel!==null ?`${avgDel} min` :"â€”", sub:"Billed â†’ Delivered", icon:"ğŸšš", color:"#1D4ED8", bg:"#EFF6FF" },
  ];

  document.getElementById("timingMetrics").innerHTML = metrics.map(m => `
    <div class="stat-card" style="background:${m.bg};border:1.5px solid ${m.color}22">
      <div style="font-size:18px;margin-bottom:4px">${m.icon}</div>
      <div class="stat-label" style="color:${m.color}">${m.label}</div>
      <div class="stat-value">${m.value}</div>
      <div style="font-size:10px;color:${m.color};opacity:.7;margin-top:2px">${m.sub}</div>
    </div>
  `).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG LINE / AREA CHART ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSvgChart(containerId, series, opts={}) {
  const W = 520, H = 200, PL=52, PR=16, PT=16, PB=48;
  const cW = W-PL-PR, cH = H-PT-PB;

  const allVals = series.flatMap(s=>s.data.map(d=>d.v));
  const maxV = Math.max(...allVals, 0.1);
  const minV = 0;

  // x positions
  const labels = series[0].data.map(d=>d.k);
  const n = labels.length;
  const xOf = i => PL + (n<=1 ? cW/2 : i/(n-1)*cW);
  const yOf = v => PT + cH - (v-minV)/(maxV-minV)*cH;

  // y-axis grid lines
  const ticks = 4;
  let gridLines="", yLabels="";
  for(let i=0;i<=ticks;i++){
    const v = minV + (maxV-minV)*i/ticks;
    const y = yOf(v);
    gridLines += `<line x1="${PL}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="#E2E8F0" stroke-width="1"/>`;
    const lbl = opts.yFmt ? opts.yFmt(v) : (v>=1000?`${(v/1000).toFixed(0)}k`:Math.round(v).toString());
    yLabels += `<text x="${PL-6}" y="${y+4}" text-anchor="end" font-size="9" fill="#94A3B8">${lbl}</text>`;
  }

  // build each series path + area
  let paths="", dots="", tooltip="";
  series.forEach(s=>{
    const pts = s.data.map((d,i)=>({x:xOf(i), y:yOf(d.v), v:d.v, k:d.k}));
    if(pts.length<1){return;}
    if(pts.length===1){
      const p=pts[0], lbl=opts.yFmt?opts.yFmt(p.v):Math.round(p.v);
      paths+=`<circle cx="${p.x}" cy="${p.y}" r="5" fill="${s.color}" stroke="#fff" stroke-width="2"/>`;
      dots+=`<text x="${p.x}" y="${p.y-12}" text-anchor="middle" font-size="10" fill="${s.color}" font-weight="700">${lbl}</text>`;
      return;
    }
    // smooth cubic bezier
    let d="M"+pts[0].x+","+pts[0].y;
    for(let i=1;i<pts.length;i++){
      const cx=(pts[i-1].x+pts[i].x)/2;
      d+=` C${cx},${pts[i-1].y} ${cx},${pts[i].y} ${pts[i].x},${pts[i].y}`;
    }
    // area fill
    let af=d+` L${pts[pts.length-1].x},${PT+cH} L${pts[0].x},${PT+cH} Z`;
    const fillId="gf"+Math.random().toString(36).slice(2,7);
    paths+=`<defs><linearGradient id="${fillId}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${s.color}" stop-opacity="0.22"/>
      <stop offset="100%" stop-color="${s.color}" stop-opacity="0.02"/>
    </linearGradient></defs>
    <path d="${af}" fill="url(#${fillId})"/>
    <path d="${d}" fill="none" stroke="${s.color}" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>`;
    // dots + tooltips
    pts.forEach(p=>{
      const lbl = opts.yFmt ? opts.yFmt(p.v) : Math.round(p.v);
      dots+=`<circle cx="${p.x}" cy="${p.y}" r="4" fill="${s.color}" stroke="#fff" stroke-width="1.5"/>`;
      // invisible hover target with tooltip
      dots+=`<g class="chart-tip-group">
        <circle cx="${p.x}" cy="${p.y}" r="12" fill="transparent"/>
        <text x="${p.x}" y="${p.y-10}" text-anchor="middle" font-size="9" fill="${s.color}" font-weight="700" class="chart-label">${lbl}</text>
      </g>`;
    });
  });

  // x-axis labels
  let xLabels="";
  const step = Math.max(1, Math.floor(n/8));
  labels.forEach((l,i)=>{
    if(i%step!==0 && i!==n-1) return;
    xLabels+=`<text x="${xOf(i)}" y="${H-6}" text-anchor="middle" font-size="9" fill="#94A3B8">${l}</text>`;
  });

  // legend
  let legend="";
  series.forEach((s,i)=>{
    legend+=`<rect x="${PL+i*130}" y="${H-16}" width="10" height="10" rx="2" fill="${s.color}"/>
    <text x="${PL+i*130+14}" y="${H-7}" font-size="10" fill="#475569">${s.name}</text>`;
  });

  const svg=`<svg width="100%" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"
    style="font-family:'Plus Jakarta Sans',sans-serif;overflow:visible">
    ${gridLines}${yLabels}
    ${paths}${dots}${xLabels}${legend}
    <line x1="${PL}" y1="${PT}" x2="${PL}" y2="${PT+cH}" stroke="#CBD5E1" stroke-width="1"/>
    <line x1="${PL}" y1="${PT+cH}" x2="${W-PR}" y2="${PT+cH}" stroke="#CBD5E1" stroke-width="1"/>
  </svg>`;

  document.getElementById(containerId).innerHTML = `<style>
    .chart-label{opacity:0;transition:opacity .15s}
    .chart-tip-group:hover .chart-label{opacity:1}
  </style>${svg}`;
}

function emptyChart(msg="No data yet") {
  return `<div class="empty" style="padding:30px">
    <div class="empty-icon" style="font-size:36px">ğŸ“‰</div>
    <div class="empty-text" style="font-size:13px">${msg}</div>
  </div>`;
}

// â”€â”€ Grouped data helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function groupByKey(data, valueFn) {
  const grouped = {};
  data.forEach(e => {
    const key = getGroupKey(e.Date);
    if (!key) return;
    grouped[key] = grouped[key] || { total:0, pending:0, received:0, count:0 };
    valueFn(grouped[key], e);
  });
  return Object.entries(grouped).sort(([a],[b])=>a.localeCompare(b)).slice(-14);
}

// â”€â”€ BAR / HISTOGRAM CHART ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBarChart(containerId, rows, series, opts={}) {
  const W=540, H=230, PL=56, PR=16, PT=16, PB=56;
  const cW=W-PL-PR, cH=H-PT-PB;
  const n=rows.length;
  if(!n){ document.getElementById(containerId).innerHTML=emptyChart(); return; }

  const allVals = series.flatMap(s => rows.map(([,v]) => s.valFn(v)));
  const maxV = Math.max(...allVals, 1);

  const ticks=4;
  let gridLines="", yLabels="";
  for(let i=0;i<=ticks;i++){
    const v=maxV*i/ticks;
    const y=PT+cH-(v/maxV)*cH;
    gridLines+=`<line x1="${PL}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="#E2E8F0" stroke-width="1"/>`;
    const lbl=opts.yFmt?opts.yFmt(v):(v>=1000?`${(v/1000).toFixed(0)}k`:Math.round(v).toString());
    yLabels+=`<text x="${PL-6}" y="${y+4}" text-anchor="end" font-size="9" fill="#94A3B8">${lbl}</text>`;
  }

  const groupW = cW/n;
  const totalBarW = Math.min(groupW*0.82, series.length*20);
  const barW = totalBarW/series.length;
  const groupPad = (groupW-totalBarW)/2;

  const MONTH_ABBR = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  let bars="";
  rows.forEach(([k,v], gi) => {
    const groupX = PL + gi*groupW;
    series.forEach((s, si) => {
      const val = s.valFn(v)||0;
      const barH = val>0 ? Math.max(3,(val/maxV)*cH) : 0;
      const x = groupX + groupPad + si*barW;
      const y = PT+cH-barH;
      const lbl = opts.yFmt ? opts.yFmt(val) : Math.round(val);
      // Show label always (not just on hover) when bar is tall enough, else show on hover
      const alwaysShow = barH > 18;
      bars+=`<g class="bar-grp">
        <rect x="${x+1}" y="${y}" width="${barW-2}" height="${barH}" rx="3" fill="${s.color}" opacity="0.88"/>
        <text x="${x+barW/2}" y="${y-4}" text-anchor="middle" font-size="8" fill="${s.color}" font-weight="700" class="bar-lbl${alwaysShow?" bar-lbl-show":""}">${lbl}</text>
      </g>`;
    });
    // Clean date display: YYYY-MM-DD â†’ DD/MM | YYYY-MM â†’ Jan | Www-YYYY â†’ Www
    let dispK = k||"";
    if (dispK.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const p = dispK.split("-"); dispK = `${p[2]}/${p[1]}`; // DD/MM
    } else if (dispK.match(/^W\d{2}-\d{4}$/)) {
      dispK = dispK.slice(0,3); // W03  (key format is W03-2026)
    } else if (dispK.match(/^\d{4}-\d{2}$/)) {
      const m = parseInt(dispK.slice(5),10); dispK = MONTH_ABBR[m-1]||dispK.slice(5);
    }
    bars+=`<text x="${groupX+groupW/2}" y="${PT+cH+13}" text-anchor="middle" font-size="9" fill="#94A3B8">${dispK}</text>`;
  });

  let legend="";
  series.forEach((s,i)=>{
    legend+=`<rect x="${PL+i*115}" y="${H-14}" width="10" height="10" rx="2" fill="${s.color}"/>
    <text x="${PL+i*115+14}" y="${H-5}" font-size="10" fill="#475569">${s.name}</text>`;
  });

  const svg=`<svg width="100%" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"
    style="font-family:'Plus Jakarta Sans',sans-serif;overflow:visible">
    ${gridLines}${yLabels}${bars}${legend}
    <line x1="${PL}" y1="${PT}" x2="${PL}" y2="${PT+cH}" stroke="#CBD5E1" stroke-width="1"/>
    <line x1="${PL}" y1="${PT+cH}" x2="${W-PR}" y2="${PT+cH}" stroke="#CBD5E1" stroke-width="1"/>
  </svg>`;

  document.getElementById(containerId).innerHTML=`<style>
    .bar-lbl{opacity:0;transition:opacity .12s}
    .bar-lbl-show{opacity:1}
    .bar-grp:hover .bar-lbl{opacity:1}
    .bar-grp rect{transition:opacity .12s}
    .bar-grp:hover rect{opacity:1!important}
  </style>${svg}`;
}

function renderValueChart(elId, data) {
  const rows = groupByKey(data, (acc, e) => {
    acc.total    += Number(e.Amount||0);
    acc.count++;
    acc[e.Status==="pending"?"pending":"received"] += Number(e.Amount||0);
  });
  if (!rows.length) { document.getElementById(elId).innerHTML = emptyChart(); return; }
  drawBarChart(elId, rows, [
    { name:"Pending",  color:"#F59E0B", valFn: v => v.pending||0  },
    { name:"Received", color:"#16A34A", valFn: v => v.received||0 },
    { name:"Total",    color:"#1D4ED8", valFn: v => v.total||0    },
  ], { yFmt: v => v>=1000 ? "â‚¹"+(v/1000).toFixed(1)+"k" : "â‚¹"+Math.round(v) });
}

function renderCountChart(elId, data) {
  const rows = groupByKey(data, (acc, e) => {
    acc.count++;
    if(e.Status==="pending")  acc.pending  = (acc.pending||0)+1;
    else                       acc.received = (acc.received||0)+1;
  });
  if (!rows.length) { document.getElementById(elId).innerHTML = emptyChart(); return; }
  drawBarChart(elId, rows, [
    { name:"Pending",  color:"#F59E0B", valFn: v => v.pending||0  },
    { name:"Received", color:"#16A34A", valFn: v => v.received||0 },
    { name:"Total",    color:"#1D4ED8", valFn: v => v.count||0    },
  ], { yFmt: v => Math.round(v) });
}

function renderTimingChart(elId, data, mode) {
  const grouped = {};
  data.forEach(e => {
    let diff;
    if (mode==="processing") {
      // Allow any status â€” processing time is order â†’ billed
      const t1 = parseTimeToHHMM(e.OrderTime), t2 = parseTimeToHHMM(e.BilledTime);
      if (t1 && t2) diff = timeDiffMinutes(t1, t2);
    }
    if (mode==="delivery") {
      // Delivery: billed â†’ delivered. Works for both pending and received
      // if DeliveryTime is filled (might still be out for delivery)
      const t1 = parseTimeToHHMM(e.BilledTime), t2 = parseTimeToHHMM(e.DeliveryTime);
      if (t1 && t2) diff = timeDiffMinutes(t1, t2);
    }
    if (diff === undefined || diff <= 0 || diff > 600) return;
    const key = getGroupKey(e.Date);
    if (!key) return;
    grouped[key] = grouped[key] || {total:0, count:0};
    grouped[key].total += diff;
    grouped[key].count++;
  });
  const rows = Object.entries(grouped).sort(([a],[b])=>a.localeCompare(b)).slice(-14);
  if (!rows.length) {
    document.getElementById(elId).innerHTML = emptyChart(
      mode==="delivery"
        ? "No delivery time data yet â€” fill in Billed Time & Delivery Time for each order"
        : "No processing time data yet â€” fill in Order Time & Billed Time"
    );
    return;
  }
  const color = mode==="processing" ? "#7C3AED" : "#0D9488";
  const label = mode==="processing" ? "Avg Processing (min)" : "Avg Delivery (min)";
  drawBarChart(elId, rows, [
    { name:label, color, valFn: v => Math.round(v.total/v.count) },
  ], { yFmt: v => Math.round(v)+"m" });
}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Filters use PERSISTENT inputs â€” never re-render the inputs themselves
// to avoid keyboard dismissal on mobile.
// Inputs are created once in initFilterBars() called on page load.

function initFilterBars() {
  initFilterBar("masterFilters",     "master",     false);
  initFilterBar("pendingFilters",    "pending",    true);
  initFilterBar("deliveriesFilters", "deliveries", true, true);
}

function initFilterBar(elId, key, pendingOnly, noStatus) {
  const el = document.getElementById(elId);
  if (!el) return;
  // Build once, bind events imperatively so inputs persist across renderAll
  el.innerHTML = `
    <input class="filter-input" id="fsearch_${key}" placeholder="ğŸ” Search by customer nameâ€¦"
      autocomplete="off" autocorrect="off" spellcheck="false"
      style="min-width:200px;max-width:280px" />
    ${!noStatus && !pendingOnly ? `
    <select class="filter-input" id="fstatus_${key}" style="min-width:120px">
      <option value="">All Status</option>
      <option value="pending">Pending</option>
      <option value="received">Received</option>
    </select>` : ""}
    <input class="filter-input" id="fdate_from_${key}" type="date"
      style="min-width:140px" title="From Date" />
    <input class="filter-input" id="fdate_to_${key}" type="date"
      style="min-width:140px" title="To Date" />
    <button class="btn-clear" id="fclear_${key}" onclick="clearFilter('${key}')" style="display:none">âœ• Clear</button>
  `;

  // Bind events imperatively (no re-render)
  const searchEl = document.getElementById(`fsearch_${key}`);
  if (searchEl) {
    searchEl.addEventListener("input", () => {
      filters[key] = filters[key] || {};
      filters[key].search = searchEl.value;
      renderTablesOnly();
      updateClearBtn(key);
    });
  }

  const statusEl = document.getElementById(`fstatus_${key}`);
  if (statusEl) {
    statusEl.addEventListener("change", () => {
      filters[key] = filters[key] || {};
      filters[key].status = statusEl.value;
      renderTablesOnly();
      updateClearBtn(key);
    });
  }

  const fromEl = document.getElementById(`fdate_from_${key}`);
  if (fromEl) {
    fromEl.addEventListener("change", () => {
      filters[key] = filters[key] || {};
      filters[key].dateFrom = fromEl.value;
      renderTablesOnly();
      updateClearBtn(key);
    });
  }

  const toEl = document.getElementById(`fdate_to_${key}`);
  if (toEl) {
    toEl.addEventListener("change", () => {
      filters[key] = filters[key] || {};
      filters[key].dateTo = toEl.value;
      renderTablesOnly();
      updateClearBtn(key);
    });
  }
}

function updateClearBtn(key) {
  const f = filters[key] || {};
  const hasFilter = Object.values(f).some(v => v);
  const btn = document.getElementById(`fclear_${key}`);
  if (btn) btn.style.display = hasFilter ? "" : "none";
}

// renderTablesOnly: re-renders table data WITHOUT touching filter inputs
function renderTablesOnly() {
  const pending      = allEntries.filter(e => e.Status === "pending");
  const totalPending = pending.reduce((s,e) => s + Number(e.Amount||0), 0);
  // Pending deliveries: Home Delivery orders with no DeliveryTime yet
  const pendDels = allEntries.filter(e => (e.OrderType||"Home Delivery") !== "Pay Later" && !e.DeliveryTime);

  document.getElementById("headerActive").textContent  = pending.length;
  document.getElementById("headerPending").textContent = fmtCur(totalPending);

  const badge = document.getElementById("pendingBadge");
  if (pending.length) { badge.textContent = pending.length; badge.style.display = "inline"; }
  else badge.style.display = "none";

  const delBadge = document.getElementById("deliveriesBadge");
  if (pendDels.length) { delBadge.textContent = pendDels.length; delBadge.style.display = "inline"; }
  else delBadge.style.display = "none";

  renderTable("masterTable",  "masterCount",  applyFilter(allEntries, filters.master),  false);
  renderTable("pendingTable", "pendingCount", applyFilter(pending,    filters.pending), true);
  renderPendingStats(pending);
  renderDeliveriesTab(pendDels);
  if (activeTab === "analytics") renderAnalytics();
  ["master","pending","deliveries"].forEach(k => updateClearBtn(k));
}

function renderDeliveriesTab(pendDels) {
  // Stats bar
  const statsEl = document.getElementById("deliveriesStats");
  if (statsEl) {
    const today = new Date().toISOString().split("T")[0];
    const todayCnt = pendDels.filter(e => e.Date === today).length;
    const totalAmt  = pendDels.reduce((s,e) => s+Number(e.Amount||0), 0);
    statsEl.innerHTML = [
      { label:"Pending Deliveries", value: pendDels.length,  color:"#1D4ED8", bg:"#EFF6FF" },
      { label:"Due Today",          value: todayCnt,         color:"#F59E0B", bg:"#FFFBEB" },
      { label:"Total Order Value",  value: fmtCur(totalAmt), color:"#7C3AED", bg:"#F5F3FF" },
    ].map(c=>`<div class="stat-card" style="background:${c.bg};border:1.5px solid ${c.color}22">
      <div class="stat-label" style="color:${c.color}">${c.label}</div>
      <div class="stat-value">${c.value}</div></div>`).join("");
  }

  // Table
  const table = document.getElementById("deliveriesTable");
  if (!table) return;
  const cols   = ["Date","BillNumber","CustomerName","Phone","Amount","ExpectedPaymentMode","TakenBy","OrderTime","BilledTime","Actions"];
  const labels = ["Date","Bill No","Customer","Phone","Amount","Exp. Mode","Taken By","Order Time","Billed Time","Actions"];
  table.querySelector("thead").innerHTML = `<tr>${labels.map(h=>`<th>${h}</th>`).join("")}</tr>`;
  const filtered = applyFilter(pendDels, filters.deliveries);
  if (!filtered.length) {
    table.querySelector("tbody").innerHTML = `<tr><td colspan="${cols.length}" class="empty"><div class="empty-icon">ğŸšš</div><div class="empty-text">No pending deliveries â€” all orders delivered!</div></td></tr>`;
    document.getElementById("deliveriesCount").textContent = "(0)";
    return;
  }
  document.getElementById("deliveriesCount").textContent = `(${filtered.length})`;
  table.querySelector("tbody").innerHTML = filtered.map(e => `
    <tr>
      <td>${fmtDate(e.Date)}</td>
      <td class="td-bill">${e.BillNumber||"â€”"}</td>
      <td class="td-name">${e.CustomerName||"â€”"}</td>
      <td>${e.Phone||"â€”"}</td>
      <td class="td-amount">${fmtCur(e.Amount)}</td>
      <td><span class="badge-expected">${e.ExpectedPaymentMode||"â€”"}</span></td>
      <td>${e.TakenBy||"â€”"}</td>
      <td>${fmtTime(e.OrderTime)}</td>
      <td>${fmtTime(e.BilledTime)}</td>
      <td class="td-actions">
        <button class="act-btn" style="background:#DCFCE7;color:#16A34A" onclick="openDeliveryModal('${e.ID}')" title="Mark Delivered">ğŸšš Mark Delivered</button>
        <button class="act-btn act-btn-edit" onclick="openEditModal('${e.ID}')" title="Edit">âœï¸</button>
      </td>
    </tr>`).join("");
}

function clearFilter(key) {
  filters[key] = {};
  // Reset visible input values
  const s = document.getElementById(`fsearch_${key}`);    if (s) s.value = "";
  const st= document.getElementById(`fstatus_${key}`);    if (st) st.value = "";
  const fd= document.getElementById(`fdate_from_${key}`); if (fd) fd.value = "";
  const td= document.getElementById(`fdate_to_${key}`);   if (td) td.value = "";
  updateClearBtn(key);
  renderTablesOnly();
}

function renderFilters() {
  // Noop â€” filters are persistent now; only called to maintain compatibility
}

function applyFilter(data, f) {
  if (!f) return data;
  return data.filter(e => {
    const s = (f.search||"").toLowerCase().trim();
    if (s && !e.CustomerName.toLowerCase().includes(s)) return false;
    if (f.status   && e.Status !== f.status) return false;
    if (f.dateFrom && e.Date < f.dateFrom)   return false;
    if (f.dateTo   && e.Date > f.dateTo)     return false;
    return true;
  });
}

function setFilter(key, field, val) {
  // legacy shim â€” kept for any direct calls
  filters[key] = filters[key] || {};
  filters[key][field] = val;
  renderTablesOnly();
}

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal() {
  editingId = null;
  billPhotoFile = null;
  document.getElementById("modalTitle").textContent  = "Add New Order";
  document.getElementById("saveBtn").textContent     = "Save Order";
  renderForm({}, false);
  document.getElementById("entryModal").style.display = "flex";
}

function openEditModal(id) {
  editingId = id;
  const e   = allEntries.find(x => x.ID === id) || {};
  document.getElementById("modalTitle").textContent  = "Edit Order";
  document.getElementById("saveBtn").textContent     = "Save Changes";
  renderForm(e, true);
  document.getElementById("entryModal").style.display = "flex";
}

function openReceiveModal(id) {
  markId = id;
  const e = allEntries.find(x => x.ID === id) || {};
  document.getElementById("receivedByInput").value = "";
  document.getElementById("receivedDateInput").value = new Date().toISOString().split("T")[0];
  document.getElementById("receivedError").style.display = "none";
  // Pre-fill bill info
  const info = document.getElementById("receivedBillInfo");
  if (info) info.innerHTML =
    `<strong>ğŸ“¦ ${e.BillNumber||"â€”"}</strong> â€” ${e.CustomerName||"â€”"}<br>` +
    `ğŸ’° Amount: <strong>${fmtCur(e.Amount)}</strong> &nbsp;|&nbsp; ` +
    `Expected Mode: <strong>${e.ExpectedPaymentMode||"â€”"}</strong>`;
  // Pre-select the expected mode
  const modeEl = document.getElementById("receivedModeInput");
  if (modeEl) {
    modeEl.innerHTML = `<option value="">-- Select mode --</option>` +
      DELIVERY_MODES.map(m=>`<option value="${m}" ${m===(e.ExpectedPaymentMode||"")?"selected":""}>${m}</option>`).join("");
  }
  document.getElementById("receivedModal").style.display = "flex";
}

function closeModal(id) { document.getElementById(id).style.display = "none"; }
function closeModalOnBg(e, id) { if (e.target === document.getElementById(id)) closeModal(id); }

function renderForm(data, isEdit) {
  const currentOrderType = data.OrderType || "Home Delivery";
  document.getElementById("entryForm").innerHTML = FORM_FIELDS
    .filter(f => {
      if (f.type === "section" || f.type === "ordertype") return (!f.editOnly || isEdit) && (!f.addOnly || !isEdit);
      return (!f.editOnly || isEdit) && (!f.addOnly || !isEdit);
    })
    .map(f => {
      if (f.type === "section") return `<div class="form-section-title">${f.label}</div>`;

      if (f.type === "ordertype") {
        const isHD = currentOrderType !== "Pay Later";
        return `<div class="form-group full" id="ordertype-wrap" style="margin-bottom:4px">
          <label class="form-label" style="margin-bottom:6px">ğŸ“‹ Order Type</label>
          <div class="order-type-toggle">
            <button type="button" class="ott-btn ${isHD?"active-delivery":""}" id="ott-hd"
              onclick="setOrderType('Home Delivery')">ğŸšš Home Delivery</button>
            <button type="button" class="ott-btn ${!isHD?"active-paylater":""}" id="ott-pl"
              onclick="setOrderType('Pay Later')">ğŸª Pay Later (Walk-in)</button>
          </div>
          <input type="hidden" id="ff_OrderType" value="${currentOrderType}" />
          <div id="ordertype-hint" style="font-size:11px;color:var(--slate-400);margin-top:5px">
            ${isHD ? "Customer ordered remotely â€” goods will be delivered to their address." : "Customer visited the shop â€” payment is due later."}
          </div>
        </div>`;
      }

      const cls = f.half ? "form-group" : "form-group full";
      const delivClass = f.deliveryOnly ? " delivery-only" : "";
      let inp = "";
      if (f.type === "select") {
        inp = `<select class="form-control" id="ff_${f.key}">
          ${(f.options||[]).map(o=>`<option value="${o}" ${(data[f.key]||"")=== o?"selected":""}>${o}</option>`).join("")}
        </select>`;
      } else if (f.type === "prepaid") {
        inp = `<label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px 12px;background:var(--green-50);border:1.5px solid var(--green-100);border-radius:8px">
          <input type="checkbox" id="ff_${f.key}" style="width:18px;height:18px;cursor:pointer" />
          <span style="font-size:13px;font-weight:600;color:var(--green-800)">âœ… This order is already paid â€” mark as received immediately</span>
        </label>`;
      } else if (f.type === "textarea") {
        inp = `<textarea class="form-control" id="ff_${f.key}" rows="2">${data[f.key]||""}</textarea>`;
      } else if (f.type === "file") {
        inp = `<div style="display:flex;flex-direction:column;gap:6px">
          <input class="form-control" type="file" id="ff_${f.key}" accept="image/*" capture="environment"
              onchange="onBillPhotoSelected(this)" style="padding:6px;display:none"/>
          <button type="button" id="billPickerBtn" onclick="document.getElementById('ff_BillPhoto').click()"
            style="padding:10px 16px;border-radius:8px;border:1.5px solid var(--slate-200);background:var(--slate-50);color:var(--slate-700);font-size:13px;font-weight:700;cursor:pointer;text-align:left">
            ğŸ“· Tap to Capture / Choose Bill Photo
          </button>
          <div id="billPreview"></div>
        </div>`;
      } else {
        inp = `<input class="form-control" type="${f.type}" id="ff_${f.key}" value="${data[f.key]||""}" />`;
      }
      return `<div class="${cls}${delivClass}" id="fgroup_${f.key}"><label class="form-label">${f.label}</label>${inp}</div>`;
    }).join("");

  // Defaults
  if (!data.Date) { const el=document.getElementById("ff_Date"); if(el) el.value=new Date().toISOString().split("T")[0]; }
  if (!data.OrderTime && !isEdit) { const el=document.getElementById("ff_OrderTime"); if(el) el.value=new Date().toTimeString().slice(0,5); }

  // Apply delivery-only visibility on initial load
  applyOrderTypeVisibility(currentOrderType);
}

function setOrderType(type) {
  const inp = document.getElementById("ff_OrderType");
  if (inp) inp.value = type;
  const hdBtn = document.getElementById("ott-hd");
  const plBtn = document.getElementById("ott-pl");
  const hint  = document.getElementById("ordertype-hint");
  if (hdBtn) { hdBtn.className = `ott-btn${type==="Home Delivery"?" active-delivery":""}`; }
  if (plBtn) { plBtn.className = `ott-btn${type==="Pay Later"?" active-paylater":""}`; }
  if (hint)  { hint.textContent = type==="Home Delivery"
    ? "Customer ordered remotely â€” goods will be delivered to their address."
    : "Customer visited the shop â€” payment is due later."; }
  applyOrderTypeVisibility(type);
}

function applyOrderTypeVisibility(type) {
  const isDelivery = type !== "Pay Later";
  document.querySelectorAll(".delivery-only").forEach(el => {
    el.classList.toggle("hidden", !isDelivery);
  });
}

function onBillPhotoSelected(input) {
  billPhotoFile = input.files?.[0] || null;
  const preview = document.getElementById("billPreview");
  const pickerBtn = document.getElementById("billPickerBtn");
  if (!preview) return;
  if (billPhotoFile) {
    const reader = new FileReader();
    reader.onload = ev => {
      preview.innerHTML = `
        <img src="${ev.target.result}" class="bill-preview-img" alt="Bill preview" />
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap">
          <div class="photo-badge">âœ… ${billPhotoFile.name}</div>
          <button type="button" onclick="document.getElementById('ff_BillPhoto').click()"
            style="padding:6px 12px;border-radius:8px;border:1.5px solid var(--orange);background:var(--orange-bg);color:var(--orange);font-size:12px;font-weight:700;cursor:pointer">
            ğŸ”„ Replace Photo
          </button>
        </div>`;
    };
    reader.readAsDataURL(billPhotoFile);
    if (pickerBtn) pickerBtn.style.display = "none";
  } else {
    preview.innerHTML = "";
    if (pickerBtn) pickerBtn.style.display = "";
  }
}

function collectForm() {
  const out = {};
  FORM_FIELDS.filter(f => f.type !== "section" && f.type !== "file").forEach(f => {
    const el = document.getElementById("ff_" + f.key);
    if (!el) return;
    if (f.type === "prepaid") out[f.key] = el.checked ? "true" : "false";
    else out[f.key] = el.value;
  });
  return out;
}

// â”€â”€ TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  activeTab = tab;
  ["master","pending","deliveries","analytics","settings"].forEach(t => {
    document.getElementById("tab-"+t).style.display = t===tab ? "" : "none";
    const tabBtn = document.querySelector(`[data-tab="${t}"]`);
    if (tabBtn) tabBtn.classList.toggle("active", t===tab);
  });
  if (tab==="analytics") renderAnalytics();
  if (tab==="settings") renderSettings();
}

function renderSettings() {
  const waEl = document.getElementById("settingWaLink");
  const shopEl = document.getElementById("settingShopName");
  const countryEl = document.getElementById("settingCountry");
  if (waEl) waEl.textContent = (typeof DELIVERY_GROUP_LINK !== "undefined" && DELIVERY_GROUP_LINK !== "YOUR_WHATSAPP_GROUP_INVITE_LINK") ? DELIVERY_GROUP_LINK : "âš ï¸ Not set yet";
  if (shopEl) shopEl.textContent = typeof SHOP_NAME !== "undefined" ? SHOP_NAME : "â€”";
  if (countryEl) countryEl.textContent = typeof COUNTRY_CODE !== "undefined" ? "+"+COUNTRY_CODE : "â€”";
}

function setGroup(g) {
  groupBy = g;
  document.querySelectorAll("[data-group]").forEach(b => b.classList.toggle("active", b.dataset.group===g));
  renderAnalytics();
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtCur(n) { return "â‚¹" + Number(n||0).toLocaleString("en-IN"); }
function fmtDate(d) {
  if (!d) return "â€”";
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const str = String(d).trim();
  // 1. Plain YYYY-MM-DD â€” split directly, no timezone confusion
  const iso = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (iso) return `${iso[3].replace(/^0/,"")} ${months[+iso[2]-1]} ${iso[1]}`;
  // 2. Sheets GMT string e.g. "Sat Jan 15 2025 00:00:00 GMT+0530 (IST)"
  //    Extract day-month-year from the readable part before "00:00"
  const gmt = str.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
  if (gmt) return `${String(gmt[1]).padStart(2,"0")} ${gmt[2]} ${gmt[3]}`;
  // 3. Fallback: JS Date parse (last resort)
  try {
    const dt = new Date(str);
    if (!isNaN(dt)) return `${String(dt.getDate()).padStart(2,"0")} ${months[dt.getMonth()]} ${dt.getFullYear()}`;
  } catch(_) {}
  return str; // absolute last resort â€” show as-is
}
// Format a time string "HH:MM" â†’ "10:20 AM"
// Also handles Google Sheets returning Date objects serialised as strings like
// "Sat Dec 30 1899 10:20:00 GMT+0530" â€” extracts hours/minutes from those too
function fmtTime(t) {
  if (!t || t === "â€”") return "â€”";
  // If it contains a year (Sheets date object stringified), parse it
  if (t.includes("1899") || t.includes("GMT") || t.includes("Z") || t.length > 8) {
    try {
      const d = new Date(t);
      if (!isNaN(d)) {
        const h = d.getHours(), m = d.getMinutes();
        const ampm = h >= 12 ? "PM" : "AM";
        const h12  = h % 12 || 12;
        return `${h12}:${String(m).padStart(2,"0")} ${ampm}`;
      }
    } catch(_) {}
  }
  // Normal "HH:MM" or "H:MM" string
  const parts = t.split(":");
  if (parts.length >= 2) {
    const h = parseInt(parts[0],10), m = parseInt(parts[1],10);
    if (!isNaN(h) && !isNaN(m)) {
      const ampm = h >= 12 ? "PM" : "AM";
      const h12  = h % 12 || 12;
      return `${h12}:${String(m).padStart(2,"0")} ${ampm}`;
    }
  }
  return t;
}

// Extracts pure HH:MM for arithmetic from whatever format Sheets returns
function parseTimeToHHMM(t) {
  if (!t) return null;
  if (t.includes("1899") || t.includes("GMT") || t.includes("Z") || t.length > 8) {
    try {
      const d = new Date(t);
      if (!isNaN(d)) return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    } catch(_) {}
  }
  return t; // already HH:MM
}

function timeDiffMinutes(t1, t2) {
  try {
    const s1 = parseTimeToHHMM(t1), s2 = parseTimeToHHMM(t2);
    if (!s1 || !s2) return -1;
    const [h1,m1] = s1.split(":").map(Number);
    const [h2,m2] = s2.split(":").map(Number);
    return (h2*60+m2) - (h1*60+m1);
  } catch { return -1; }
}
function getWeek(dateStr) {
  try {
    const d=new Date(dateStr), f=new Date(d.getFullYear(),0,1);
    return Math.ceil(((d-f)/86400000+f.getDay()+1)/7);
  } catch { return 0; }
}
function getWeekKey(dateStr) {
  if (!dateStr) return "";
  try { return `W${String(getWeek(dateStr)).padStart(2,"0")}-${dateStr.slice(0,4)}`; }
  catch { return ""; }
}
function getGroupKey(dateStr) {
  if (!dateStr) return "";
  const k = groupBy==="day"? dateStr : groupBy==="week"? getWeekKey(dateStr) : dateStr.slice(0,7);
  return (k && !k.includes("undefined") && !k.includes("NaN")) ? k : "";
}

let toastTimer;
function showToast(msg, type="success") {
  clearTimeout(toastTimer);
  const old = document.querySelector(".toast");
  if (old) old.remove();
  const el = document.createElement("div");
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  toastTimer = setTimeout(()=>el.remove(), 3500);
}

// â”€â”€ SAMPLE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSampleData() {
  return [
    { ID:"s1", Date:"2026-02-20", OrderType:"Home Delivery", CustomerName:"Ramesh Kumar",  Phone:"9876543210", BillNumber:"INV-001", TakenBy:"Suresh",  OrderTime:"10:20", BilledTime:"10:35", DeliveryTime:"11:10", DeliveryPerson:"Ravi",  PaymentMode:"Cash",    ExpectedPaymentMode:"Cash",    Amount:1250, ReceivedBy:"",       Status:"pending",  Notes:"Regular customer" },
    { ID:"s2", Date:"2026-02-20", OrderType:"Home Delivery", CustomerName:"Priya Lakshmi", Phone:"9123456789", BillNumber:"INV-002", TakenBy:"Anand",   OrderTime:"11:00", BilledTime:"11:12", DeliveryTime:"11:50", DeliveryPerson:"Kumar", PaymentMode:"Paytm",   ExpectedPaymentMode:"Paytm",   Amount:850,  ReceivedBy:"",       Status:"pending",  Notes:"" },
    { ID:"s3", Date:"2026-02-19", OrderType:"Home Delivery", CustomerName:"Vijay Anand",   Phone:"9988776655", BillNumber:"INV-003", TakenBy:"Suresh",  OrderTime:"14:00", BilledTime:"14:18", DeliveryTime:"14:55", DeliveryPerson:"Ravi",  PaymentMode:"Phonepe", ExpectedPaymentMode:"Phonepe", Amount:2100, ReceivedBy:"Suresh", Status:"received", Notes:"" },
    { ID:"s4", Date:"2026-02-19", OrderType:"Pay Later",     CustomerName:"Ramesh Kumar",  Phone:"9876543210", BillNumber:"INV-004", TakenBy:"Anand",   OrderTime:"15:30", BilledTime:"15:42", DeliveryTime:"",      DeliveryPerson:"",      PaymentMode:"Cash",    ExpectedPaymentMode:"Cash",    Amount:670,  ReceivedBy:"",       Status:"pending",  Notes:"Walk-in, paid later" },
    { ID:"s5", Date:"2026-02-18", OrderType:"Pay Later",     CustomerName:"Meena Devi",    Phone:"9000000001", BillNumber:"INV-005", TakenBy:"Suresh",  OrderTime:"09:45", BilledTime:"10:00", DeliveryTime:"",      DeliveryPerson:"",      PaymentMode:"Sodexo",  ExpectedPaymentMode:"Sodexo",  Amount:3200, ReceivedBy:"Suresh", Status:"received", Notes:"Bulk walk-in order" },
    { ID:"s6", Date:"2026-02-18", OrderType:"Home Delivery", CustomerName:"Arjun Pillai",  Phone:"9111222333", BillNumber:"INV-006", TakenBy:"Anand",   OrderTime:"13:15", BilledTime:"13:28", DeliveryTime:"14:05", DeliveryPerson:"Kumar", PaymentMode:"Card",    ExpectedPaymentMode:"Razorpay",Amount:1890, ReceivedBy:"Anand",  Status:"received", Notes:"" },
  ];
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  allEntries = getSampleData();
  initFilterBars(); // creates persistent inputs â€” must run before renderAll
  renderAll();
  startAutoSync(); // background sync every 2 min (won't fire in demo mode)
  if (APPS_SCRIPT_URL !== "YOUR_APPS_SCRIPT_WEB_APP_URL") loadData();
};
</script>
</body>
</html>
